<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Utki ‚Äî –ü—É–∑—ã—Ä–∏–∫–∏‚Äë—É—Ç—è—Ç–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: transparent;
      height: 100%;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    #bubble-extension {
      position: absolute;
      inset: 0;
      pointer-events: auto;
      overflow: hidden;
      z-index: 999999; /* –ø–æ–≤–µ—Ä—Ö –æ–±—ä–µ–∫—Ç–æ–≤ Genially */
    }

    /* HUD: —Å—á—ë—Ç—á–∏–∫ —Å –∏–∫–æ–Ω–∫–æ–π –ø—Ä–µ–¥–º–µ—Ç–∞ */
    #counter {
      position: absolute;
      top: 20px;
      left: 20px;
      background: linear-gradient(135deg, rgba(0,0,0,.55), rgba(0,0,0,.4));
      padding: 10px 14px;
      border-radius: 12px;
      font-weight: 800;
      color: #fff;
      font-size: 18px;
      letter-spacing: .2px;
      box-shadow: 0 4px 18px rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.12);
      z-index: 300;
      pointer-events: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-shadow: 0 0 10px rgba(255,255,255,.25);
    }
    #counter .icon {
      width: 26px;
      height: 26px;
      flex: 0 0 auto;
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
      filter: drop-shadow(0 0 6px rgba(255,255,255,.35));
      border-radius: 6px;
    }

    /* –ö–Ω–æ–ø–∫–∞/–∫–∞—Ä—Ç–æ—á–∫–∞ –∑–∞–¥–∞–Ω–∏—è */
    .task {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(135deg, #4facfe, #00f2fe);
      color: #fff;
      padding: 24px 36px;
      border-radius: 20px;
      font-size: 22px;
      text-align: center;
      box-shadow: 0 6px 16px rgba(0,0,0,0.3);
      pointer-events: auto;
      cursor: pointer;
      z-index: 200;
      max-width: min(92vw, 900px);
    }

    /* –ê–Ω–∏–º–∞—Ü–∏–∏ –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–π –º–µ—Ö–∞–Ω–∏–∫–∏ */
    @keyframes sparkle {
      0% { opacity: 0; transform: scale(0.5); }
      50% { opacity: 1; transform: scale(1.2); }
      100% { opacity: 0; transform: scale(0.5); }
    }
    @keyframes confetti {
      0% { opacity: 0; transform: scale(0.7) rotate(-10deg); }
      50% { opacity: 1; transform: scale(1.2) rotate(15deg); }
      100% { opacity: 0; transform: scale(0.7) rotate(-10deg); }
    }

    /* NEW: —á–∞—Å—Ç–∏—Ü—ã ¬´—Ä–∞—Å—Å—ã–ø–∞–Ω–∏–µ –ø–æ –∫—É—Å–æ—á–∫–∞–º¬ª */
    .bit{
      position: absolute;
      width: 6px;
      height: 6px;
      pointer-events: none;
      z-index: 350;
      background: radial-gradient(circle at 30% 30%, #fff, rgba(255,255,255,.7) 40%, rgba(255,255,255,0) 70%);
      border-radius: 50%;
      filter: drop-shadow(0 0 6px rgba(255,255,255,.55));
      animation: scatter .7s ease-out forwards;
    }
    @keyframes scatter{
      from{ opacity: 1; transform: translate(0,0) scale(1); }
      to{ opacity: 0; transform: translate(var(--tx), var(--ty)) scale(.4); }
    }

    .sparkle {
      position: absolute;
      font-size: 18px;
      pointer-events: none;
      animation: sparkle 0.6s ease-out forwards;
      z-index: 320;
    }
  </style>
</head>
<body>
  <div id="bubble-extension" aria-live="polite"></div>
  <div id="dbg" style="position:absolute;left:12px;bottom:12px;background:rgba(0,0,0,.55);color:#fff;padding:6px 10px;border-radius:8px;font:12px/1.3 ui-monospace;z-index:1000000;display:none"></div>

  <script>
    (function(){
      const root = document.getElementById('bubble-extension');
      const urlParams = new URLSearchParams(window.location.search);
      const DEBUG = urlParams.get('debug') === '1';
      const dbg = () => document.getElementById('dbg');
      function logDbg(msg){
        if(!DEBUG) return;
        const d = dbg(); if(!d) return;
        d.style.display='block';
        d.textContent = String(msg);
      }

      const JSON_BASE = "https://nikashum93.github.io/texts/data/"; // —Å–µ—Ä–≤–µ—Ä —Å JSON

      // --- –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ---
      const id = urlParams.get('id');
      const paramImg = decodeURIComponent(urlParams.get('img') || '');
      const defaultDuck = 'https://media.tenor.com/_-Y9OYD_cWwAAAAi/duck-bwong.gif';
      const finalTextParam = decodeURIComponent(urlParams.get('final') || 'üéâ Well Done!');

      // –∑–∞–¥–∞—á–∏ –∏–∑ URL (—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º —Å–ø–æ—Å–æ–±–æ–º)
      const URL_TASKS = {};
      for (let [key, value] of urlParams.entries()) {
        if (key.startsWith('task')) {
          const idx = parseInt(key.replace('task',''));
          URL_TASKS[idx] = decodeURIComponent(value);
        }
      }

      // --- —Å–æ—Å—Ç–æ—è–Ω–∏–µ ---
      let bubbleImg = paramImg || defaultDuck;
      let finalText = finalTextParam;
      let TASKS = [];
      let total = 0;
      let popped = 0;
      let finalUnlocked = false;
      const bubbles = [];
      const BUBBLE_SIZE = 80;

      // HUD
      const counter = document.createElement('div');
      counter.id = 'counter';
      const icon = document.createElement('span');
      icon.className = 'icon';
      const countText = document.createElement('span');
      countText.textContent = '0 / 0';
      counter.appendChild(icon);
      counter.appendChild(countText);
      root.appendChild(counter);

      function setCounterIcon(url){
        if(url){
          icon.style.backgroundImage = `url(${url})`;
          icon.style.display = '';
        } else {
          icon.style.backgroundImage = 'none';
          icon.style.display = 'none';
        }
      }

      // —Ä–∞–∑–º–µ—Ä—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
      function getRootSize(){
        return {
          width: root.clientWidth || window.innerWidth,
          height: root.clientHeight || window.innerHeight
        };
      }

      // --- –∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, –µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω id ---
      (async function boot(){
        if(id){
          try{
            const res = await fetch(`${JSON_BASE}${encodeURIComponent(id)}.json?v=${Date.now()}`, {cache:'no-store'});
            const cfg = await res.json();
            logDbg('JSON ok');
            hydrateFromConfig(cfg);
          }catch(e){
            console.warn('JSON load failed', e);
            logDbg('JSON fail ‚Üí URL');
            hydrateFromURL(); // fallback
          }
        } else {
          hydrateFromURL();
        }
        setCounterIcon(bubbleImg);
        countText.innerHTML = `<strong>${popped} / ${total}</strong>`;
        spawnAll();
        animate();
        window.addEventListener('resize', keepInsideOnResize);
      })();

      // –∑–∞–ø–æ–ª–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ JSON —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ (edit.html)
      function hydrateFromConfig(cfg){
        // —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç
        if(typeof cfg.finalFeedback === 'string' && cfg.finalFeedback.trim()){
          finalText = cfg.finalFeedback.trim();
        }
        // –∫–∞—Ä—Ç–∏–Ω–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º style.bgImage –µ—Å–ª–∏ –µ—Å—Ç—å
        if(cfg.style && cfg.style.bgImage && /^https?:\\/\\//i.test(cfg.style.bgImage)){
          bubbleImg = cfg.style.bgImage.trim();
        }
        // –∑–∞–¥–∞—á–∏: –µ—Å–ª–∏ –µ—Å—Ç—å tasks, –≤–æ–∑—å–º—ë–º –∏—Ö; –∏–Ω–∞—á–µ ‚Äî –∏–∑ —É—Ä–æ–≤–Ω–µ–π –≤–æ–∑—å–º—ë–º target
        if(Array.isArray(cfg.tasks) && cfg.tasks.length){
          TASKS = cfg.tasks.map(t => (t && (t.prompt || t.text || String(t))) );
        } else if(Array.isArray(cfg.levels) && cfg.levels.length){
          TASKS = cfg.levels.map(lv => String(lv && lv.target ? lv.target : 'Task'));
        } else {
          TASKS = ['Task 1'];
        }
        total = TASKS.length;
      }

      // –∑–∞–ø–æ–ª–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ URL-–ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (–∫–∞–∫ –≤ –∏—Å—Ö–æ–¥–Ω–∏–∫–µ)
      function hydrateFromURL(){
        const ids = Object.keys(URL_TASKS).map(n=>parseInt(n)).sort((a,b)=>a-b);
        TASKS = ids.map(i => URL_TASKS[i]);
        total = TASKS.length || 6; // –µ—Å–ª–∏ –∑–∞–¥–∞—á –Ω–µ—Ç ‚Äî –ø—É—Å—Ç—å –±—É–¥–µ—Ç 6 —É—Ç—è—Ç –¥–ª—è —Ç–µ—Å—Ç–∞
      }

      // —Å–ø–∞—É–Ω —É—Ç—è—Ç/–ø—Ä–µ–¥–º–µ—Ç–æ–≤
      function spawnAll(){
        for(let i=1;i<=total;i++){
          const el = document.createElement('img');
          el.src = bubbleImg;
          el.style.opacity = '1';
          Object.assign(el.style, {
            position: 'absolute',
            width: BUBBLE_SIZE + 'px',
            height: BUBBLE_SIZE + 'px',
            pointerEvents: 'auto',
            cursor: 'pointer',
            zIndex: 100,
            transition: 'transform 0.2s ease'
          });

          const { width: maxW, height: maxH } = getRootSize();
          el.style.left = (Math.random() * (maxW - BUBBLE_SIZE)) + 'px';
          el.style.top  = (Math.random() * (maxH - BUBBLE_SIZE)) + 'px';

          const dx = (Math.random()*2 - 1) * 1.5;
          const dy = (Math.random()*2 - 1) * 1.5;
          const bubble = { el, dx, dy, id: i };
          bubbles.push(bubble);

          el.addEventListener('click', () => onPop(bubble));
          el.addEventListener('mouseenter', () => { bubble.dx *= 0.2; bubble.dy *= 0.2; });
          el.addEventListener('mouseleave', () => { bubble.dx *= 5; bubble.dy *= 5; });

          root.appendChild(el);
        }
      }

      function onPop(bubble){
        // –∑–≤—É–∫
        try{ new Audio('pop.mp3').play().catch(()=>{}); }catch(_){}
        // ¬´–∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ¬ª
        const el = bubble.el;
        const rect = el.getBoundingClientRect();
        el.remove();
        // —ç—Ñ—Ñ–µ–∫—Ç: –∏—Å–∫—Ä—ã
        const sparkle = document.createElement('div');
        sparkle.textContent = '‚ú®';
        Object.assign(sparkle.style, {
          position: 'absolute',
          left: rect.left + 'px',
          top: rect.top + 'px',
          fontSize: '18px',
          zIndex: 150,
          pointerEvents: 'none',
          animation: 'sparkle 0.6s ease-out forwards'
        });
        root.appendChild(sparkle);
        setTimeout(() => sparkle.remove(), 650);

        // —ç—Ñ—Ñ–µ–∫—Ç: ¬´—Ä–∞—Å—Å—ã–ø–∞–Ω–∏–µ¬ª ‚Äî —á–∞—Å—Ç–∏—Ü—ã
        for(let j=0;j<18;j++){
          const bit = document.createElement('div');
          bit.className = 'bit';
          bit.style.left = (rect.left + rect.width/2) + 'px';
          bit.style.top  = (rect.top + rect.height/2) + 'px';
          const ang = Math.random()*Math.PI*2;
          const dist = 30 + Math.random()*90;
          bit.style.setProperty('--tx', (Math.cos(ang)*dist) + 'px');
          bit.style.setProperty('--ty', (Math.sin(ang)*dist) + 'px');
          bit.style.width = (4 + Math.random()*4) + 'px';
          bit.style.height = bit.style.width;
          root.appendChild(bit);
          setTimeout(()=> bit.remove(), 800);
        }

        // –∫–∞—Ä—Ç–æ—á–∫–∞ –∑–∞–¥–∞–Ω–∏—è
        showMessage(bubble.id);

        // —Å—á—ë—Ç—á–∏–∫
        popped++;
        countText.innerHTML = `<strong>${popped} / ${total}</strong>`;
      }

      // —É–¥–µ—Ä–∂–∏–≤–∞–µ–º –≤–Ω—É—Ç—Ä–∏ –ø—Ä–∏ —Ä–µ—Å–∞–π–∑–µ
      function keepInsideOnResize(){
        const { width: W, height: H } = getRootSize();
        for(const b of bubbles){
          if(!b.el.parentNode) continue;
          let x = parseFloat(b.el.style.left) || 0;
          let y = parseFloat(b.el.style.top)  || 0;
          if (x > W - BUBBLE_SIZE) b.el.style.left = (W - BUBBLE_SIZE) + 'px';
          if (y > H - BUBBLE_SIZE) b.el.style.top  = (H - BUBBLE_SIZE) + 'px';
        }
      }

      function animate(){
        const { width: W, height: H } = getRootSize();
        for (const b of bubbles) {
          if (!b.el.parentNode) continue;
          let x = parseFloat(b.el.style.left) || 0;
          let y = parseFloat(b.el.style.top)  || 0;
          x += b.dx; y += b.dy;
          if (x < 0) { x = 0; b.dx = -b.dx + (Math.random() - 0.5) * 0.4; }
          if (x > W - BUBBLE_SIZE) { x = W - BUBBLE_SIZE; b.dx = -b.dx + (Math.random() - 0.5) * 0.4; }
          if (y < 0) { y = 0; b.dy = -b.dy + (Math.random() - 0.5) * 0.4; }
          if (y > H - BUBBLE_SIZE) { y = H - BUBBLE_SIZE; b.dy = -b.dy + (Math.random() - 0.5) * 0.4; }
          if (Math.abs(b.dx) < 0.3) b.dx += (Math.random() - 0.5) * 0.5;
          if (Math.abs(b.dy) < 0.3) b.dy += (Math.random() - 0.5) * 0.5;
          b.dx = Math.max(-1.5, Math.min(1.5, b.dx));
          b.dy = Math.max(-1.5, Math.min(1.5, b.dy));
          b.el.style.left = x + 'px';
          b.el.style.top  = y + 'px';
        }
        requestAnimationFrame(animate);
      }

      function showMessage(id){
        const msg = document.createElement('div');
        msg.className = 'task';
        msg.innerHTML = TASKS[id-1] || `<b>Task ${id}</b>`;
        msg.addEventListener('click', () => {
          msg.remove();
          if (popped === total && !finalUnlocked) {
            finalUnlocked = true;
            showFinal();
          }
        });
        root.appendChild(msg);
      }

      function showFinal(){
        // —Å–∫—Ä—ã—Ç—å HUD
        counter.remove();
        const chest = document.createElement('img');
        chest.src = 'https://img.genially.com/64233afb55129a0017751c8e/915b9b98-7a24-4b3f-887a-28042ba9acca.png';
        Object.assign(chest.style, {
          position: 'absolute',
          top: '50%',
          left: '50%',
          transform: 'translate(-50%, -50%) scale(1)',
          width: '240px',
          cursor: 'pointer',
          zIndex: 300,
          pointerEvents: 'auto',
          transition: 'transform 0.3s ease'
        });
        root.appendChild(chest);

        chest.addEventListener('click', () => {
          chest.src = 'https://img.genially.com/64233afb55129a0017751c8e/d76550fd-2622-441f-bbf2-faee6906772e.png';
          chest.style.transform = 'translate(-50%, -50%) scale(1.1)';
          try{ new Audio('win.mp3').play().catch(()=>{});}catch(_){}

          const label = document.createElement('div');
          label.textContent = finalText;
          Object.assign(label.style, {
            position: 'absolute',
            top: '32%',
            left: 'calc(50% - 6px)',
            transform: 'translate(-50%, -50%)',
            fontSize: '32px',
            fontWeight: 'bold',
            color: '#fff',
            padding: '16px 30px',
            background: 'linear-gradient(135deg, #e67e22, #f1c40f)',
            borderRadius: '16px',
            fontFamily: 'Comic Sans MS, sans-serif',
            boxShadow: '0 8px 20px rgba(0,0,0,0.3)',
            zIndex: 400,
            pointerEvents: 'none',
            textShadow: '2px 2px 6px rgba(0,0,0,0.4)'
          });
          root.appendChild(label);

          const confetti = document.createElement('div');
          confetti.textContent = 'üéä‚ú®üíéü™ô';
          Object.assign(confetti.style, {
            position: 'absolute',
            top: '42%',
            left: '50%',
            transform: 'translate(-50%, -50%)',
            fontSize: '32px',
            zIndex: 350,
            animation: 'confetti 1.2s ease-out forwards',
            pointerEvents: 'none'
          });
          root.appendChild(confetti);
          setTimeout(() => confetti.remove(), 1200);
        });
      }
    })();
  </script>
</body>
</html>
