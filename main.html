<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>–°–≤–µ—Ç–ª—è—á–∫–∏</title>

  <!-- MathJax –¥–ª—è —Ñ–æ—Ä–º—É–ª -->
 <script>
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']]
    }
  };
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>


  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: transparent;
    }
    #bubble-extension {
      position: absolute;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      pointer-events: auto; overflow: hidden;
      z-index: 999999;
    }

    /* HUD counter with icon */
    #counter { display:inline-flex; align-items:center; gap:8px; }
    #counter .icon {
      width:26px; height:26px;
      background-size:contain; background-repeat:no-repeat; background-position:center;
      border-radius:6px; filter:drop-shadow(0 0 6px rgba(0,0,0,.2));
    }

    /* –í—Å–ø—ã—à–∫–∏ –æ—Ç –ø—É–∑—ã—Ä–µ–π */
    @keyframes sparkle {
      0% { opacity: 0; transform: scale(0.5); }
      50% { opacity: 1; transform: scale(1.2); }
      100% { opacity: 0; transform: scale(0.5); }
    }

    .bit{
      position:absolute; width:6px; height:6px; pointer-events:none; z-index:350;
      background:radial-gradient(circle at 30% 30%, #fff, rgba(255,255,255,.7) 40%, rgba(255,255,255,0) 70%);
      border-radius:50%; box-shadow:0 0 6px rgba(255,255,255,.45);
      animation:scatter .7s ease-out forwards;
    }
    @keyframes scatter{
      from{opacity:1; transform:translate(0,0) scale(1)}
      to  {opacity:0; transform:translate(var(--tx),var(--ty)) scale(.4)}
    }

    /* –ö–æ–Ω—Ñ–µ—Ç—Ç–∏ —Å—Ç–∞—Ä–æ–µ (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ) */
    @keyframes confetti {
      0% { opacity: 0; transform: scale(0.7) rotate(-10deg); }
      50% { opacity: 1; transform: scale(1.2) rotate(15deg); }
      100% { opacity: 0; transform: scale(0.7) rotate(-10deg); }
    }

    /* –í—ã–ª–µ—Ç —Ñ–∏–¥–±–µ–∫–∞ */
    @keyframes popUp {
      0%   { opacity: 0; transform: scale(0.7); }
      60%  { opacity: 1; transform: scale(1.08); }
      100% { opacity: 1; transform: scale(1); }
    }

    /* –†–∞–∑–ª–µ—Ç –±–ª—ë—Å—Ç–æ–∫ –æ—Ç —Å—É–Ω–¥—É–∫–∞ */
    @keyframes sparkFly {
      0% { opacity: 1; transform: translate(-50%, -50%) scale(0.8); }
      100% {
        opacity: 0;
        transform: translate(
          calc(-50% + (var(--dx))),
          calc(-50% + (var(--dy)))
        ) scale(0.4);
      }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.85); }
      to   { opacity: 1; transform: scale(1); }
    }

    @keyframes shake {
      0%,100%{ transform:translate(-50%,-50%) translateX(0); }
      20%{ transform:translate(-50%,-50%) translateX(-6px); }
      40%{ transform:translate(-50%,-50%) translateX(6px); }
      60%{ transform:translate(-50%,-50%) translateX(-4px); }
      80%{ transform:translate(-50%,-50%) translateX(4px); }
    }

    /* ---------- BUTTON INTERACTIONS ---------- */
    .kgb-btn{
      transition:
        transform 0.12s ease,
        box-shadow 0.12s ease,
        filter 0.12s ease;
    }
    .kgb-btn:hover{
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 10px 22px rgba(0,0,0,0.35);
      filter: brightness(1.05);
    }
    .kgb-btn:active{
      transform: translateY(1px) scale(0.97);
      box-shadow: 0 4px 10px rgba(0,0,0,0.25);
    }

    /* ---------- FIREWORK (correct answer) ---------- */
    @keyframes firework {
      0%   { transform: translate(-50%, -50%) scale(0.2); opacity: 1; }
      80%  { opacity: 1; }
      100% {
        transform:
          translate(
            calc(-50% + var(--dx)),
            calc(-50% + var(--dy))
          )
          scale(0.6);
        opacity: 0;
      }
    }
    .firework{
      position:absolute;
      left:50%;
      top:50%;
      font-size:22px;
      animation: firework 900ms ease-out forwards;
      pointer-events:none;
      z-index:9999;
      filter: drop-shadow(0 0 6px rgba(255,255,255,0.6));
    }
  </style>

</head>
<body>
  <div id="bubble-extension"></div>

  <script>
(function(){
  const root = document.getElementById('bubble-extension');
  const urlParams = new URLSearchParams(window.location.search);

  // –ì–¥–µ –ª–µ–∂–∞—Ç JSON –æ—Ç —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
  const JSON_BASE = "https://nikashum93.github.io/texts/data/";
  const cfgId = urlParams.get('id');

  // –ö–æ–Ω—Ñ–∏–≥ –∏–∑ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
  let feedbackImage = "";
  let sounds = {
    pop:     "https://nikashum93.github.io/utki/pop.mp3",
    open:    "https://nikashum93.github.io/utki/open.mp3",
    correct: "https://nikashum93.github.io/utki/correct.mp3",
    wrong:   "https://nikashum93.github.io/utki/wrong.mp3"
  };

  let styleTask = null;
  let styleFeedback = null;
  let uiLang = 'ru';           // 'ru','en','es','de','fr','it','ja','zh'
  let feedbackEnabled = true;  // –º–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–∏–¥–±–µ–∫
  let orderMode = false;       // —Ä–µ–∂–∏–º ¬´—Å–æ–±–µ—Ä–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ¬ª –¥–ª—è –≤—Å–µ—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –∑–∞–¥–∞–Ω–∏–π

  // ‚úÖ –í–ê–ñ–ù–û: lockNext —Ç–µ–ø–µ—Ä—å –æ–∑–Ω–∞—á–∞–µ—Ç –ù–ï "—Å—Ç—Ä–æ–≥–∏–π –ø–æ—Ä—è–¥–æ–∫",
  // –∞ "–Ω–µ–ª—å–∑—è –æ—Ç–∫—Ä—ã—Ç—å –Ω–æ–≤—ã–π –ø—É–∑—ã—Ä—ë–∫, –ø–æ–∫–∞ –Ω–µ –∑–∞–∫—Ä—ã—Ç–æ —Ç–µ–∫—É—â–µ–µ –∑–∞–¥–∞–Ω–∏–µ".
  let lockNext = true;

  // —Ç–æ, —á—Ç–æ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è—Ç—å —á–µ—Ä–µ–∑ URL (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
  let finalText = decodeURIComponent(urlParams.get('final') || "üéâ Well Done!");
  let bubbleImg = decodeURIComponent(urlParams.get('img')   || "https://media.tenor.com/_-Y9OYD_cWwAAAAi/duck-bwong.gif");

  function setCounterIcon(url){
    try{
      const el = document.querySelector('#counter .icon');
      if (el) el.style.backgroundImage = url ? `url(${url})` : 'none';
    }catch(_){}
  }

  // –ó–∞–¥–∞—á–∏ (—Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç —á–µ—Ä–µ–∑ URL —Ç–æ–∂–µ –ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞–µ–º)
  const TASKS = {};
  for (let [key, value] of urlParams.entries()) {
    if (key.startsWith('task')) {
      const id = parseInt(key.replace('task', ''));
      TASKS[id] = decodeURIComponent(value);
    }
    if (key === 'lockNext') {
      const v = String(value || '').toLowerCase();
      if (v === '0' || v === 'false' || v === 'off') lockNext = false;
    }
  }

  // –°–æ—Å—Ç–æ—è–Ω–∏—è
  let total = 0;
  let popped = 0;
  let finalUnlocked = false;
  const bubbles = [];
  const BUBBLE_SIZE = 80;

  // ‚úÖ –±–ª–æ–∫ –∫–ª–∏–∫–æ–≤, –ø–æ–∫–∞ –æ—Ç–∫—Ä—ã—Ç–æ –∑–∞–¥–∞–Ω–∏–µ
  let taskOpen = false;

  // –ß—Ç–æ–±—ã —Å—á–∏—Ç–∞—Ç—å "–≤—ã–ø–æ–ª–Ω–µ–Ω–æ" —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ Done/–ø—Ä–∞–≤–∏–ª—å–Ω–æ
  let pendingBubbleEl = null;
  let pendingBubbleId = null;

  // ‚úÖ –ü–ê–†–ê–ú–ï–¢–†–´ –ü–õ–ê–í–ù–û–ì–û –î–í–ò–ñ–ï–ù–ò–Ø (–¢–û–õ–¨–ö–û –î–õ–Ø –ü–£–ó–´–†–ï–ô)
  const EDGE_PAD = 12;                // "–Ω–µ –¥–æ—Ö–æ–¥—è –¥–æ –∫—Ä–∞—è"
  const MAX_SPEED = 52;               // px/sec (—Å–ø–æ–∫–æ–π–Ω–æ)
  const MIN_SPEED = 16;               // px/sec
  const HOVER_FACTOR = 0.10;          // –ø–æ—á—Ç–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
  const DAMP = 0.985;                 // –º—è–≥–∫–∞—è –∏–Ω–µ—Ä—Ü–∏—è
  const SEPARATION_DIST = BUBBLE_SIZE * 1.12; // —á—Ç–æ–±—ã –Ω–µ –∫—É—á–∫–æ–≤–∞–ª–∏—Å—å
  const SEPARATION_PUSH = 18;         // —Å–∏–ª–∞ —Ä–∞—Å—Ç–∞–ª–∫–∏–≤–∞–Ω–∏—è (–º—è–≥–∫–æ)

  let lastT = performance.now();

  // HUD-—Å—á—ë—Ç—á–∏–∫
  const counter = document.createElement('div');
  counter.id = 'counter';

  Object.assign(counter.style, {
    position: 'absolute',
    top: '16px',
    left: '16px',
    padding: '8px 14px',
    borderRadius: '14px',
    background: 'rgba(0,0,0,0.55)',
    color: '#fff',
    fontWeight: '900',
    zIndex: 500,
    backdropFilter: 'blur(6px)',
    display: 'inline-flex',
    alignItems: 'center',
    gap: '8px'
  });

  const counterIcon = document.createElement('span'); counterIcon.className='icon';
  const counterTxt  = document.createElement('span'); counterTxt.className='txt';
  counter.appendChild(counterIcon);
  counter.appendChild(counterTxt);
  root.appendChild(counter);

  function refreshCounter(){
    total = Object.keys(TASKS).length;
    setCounterIcon(bubbleImg);
    counterTxt.innerHTML = `<strong>${popped} / ${total}</strong>`;
  }

  // ------- helpers for opacity (only background) -------
  function hexToRgba(hex, alpha){
    const h = String(hex||'').trim();
    const m = h.match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i);
    if(!m) return null;
    let x = m[1];
    if(x.length===3) x = x.split('').map(c=>c+c).join('');
    const r = parseInt(x.slice(0,2),16);
    const g = parseInt(x.slice(2,4),16);
    const b = parseInt(x.slice(4,6),16);
    const a = Math.max(0, Math.min(1, Number(alpha)));
    return `rgba(${r},${g},${b},${a})`;
  }
  function applyBgWithOpacity(el, bg, opacity){
    if(!bg) return;
    const op = (typeof opacity === 'number') ? opacity : 1;
    const rgba = hexToRgba(bg, op);
    if(rgba){
      el.style.background = rgba;
      return;
    }
    el.style.background = bg;
  }

  function denyClickFeedback(){
    const s = document.createElement('div');
    Object.assign(s.style,{
      position:'absolute', top:'50%', left:'50%',
      width:'0', height:'0',
      zIndex: 999998,
      animation:'shake .35s ease',
      pointerEvents:'none'
    });
    root.appendChild(s);
    setTimeout(()=>s.remove(), 380);
  }

  function finishCurrentTask(){
    if (pendingBubbleEl && pendingBubbleEl.parentNode) pendingBubbleEl.remove();

    popped++;
    refreshCounter();

    taskOpen = false;
    pendingBubbleEl = null;
    pendingBubbleId = null;

   if (popped === total && !finalUnlocked) {
  finalUnlocked = true;
  playSound(sounds.open);   // ‚úÖ –ø–æ–±–µ–¥–Ω—ã–π –∑–≤—É–∫ (–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–π, –µ—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å)
  showFinal();
}

  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: —Ç—è–Ω–µ–º JSON, –µ—Å–ª–∏ –µ—Å—Ç—å id
  (async function init(){
    if (cfgId){
      try{
        const res = await fetch(`${JSON_BASE}${encodeURIComponent(cfgId)}.json?v=${Date.now()}`, { cache:'no-store' });
        const cfg = await res.json();

        let quizMaxOptions = 4;
        let quizUseOtherCorrect = false;
        if (typeof cfg?.quizMaxOptions === 'number') {
          quizMaxOptions = Math.max(2, Math.min(10, Math.floor(cfg.quizMaxOptions)));
        }
        if (cfg?.quizUseOtherCorrect === true) {
          quizUseOtherCorrect = true;
        }

        if (cfg?.style?.bgImage) bubbleImg = cfg.style.bgImage;
        if (typeof cfg?.finalFeedback === 'string') finalText = cfg.finalFeedback;
        if (cfg?.feedbackImage) feedbackImage = cfg.feedbackImage;

        if (cfg?.sounds?.pop)     sounds.pop     = cfg.sounds.pop;
        if (cfg?.sounds?.open)    sounds.open    = cfg.sounds.open;
        if (cfg?.sounds?.correct) sounds.correct = cfg.sounds.correct;
        if (cfg?.sounds?.wrong)   sounds.wrong   = cfg.sounds.wrong;

        if (cfg?.style?.task)     styleTask     = cfg.style.task;
        if (cfg?.style?.feedback) styleFeedback = cfg.style.feedback;

        if (cfg?.lang && ['ru','en','es','de','fr','it','ja','zh'].includes(cfg.lang)) uiLang = cfg.lang;
        if (cfg?.language && ['ru','en','es','de','fr','it','ja','zh'].includes(cfg.language)) uiLang = cfg.language;
        const urlLang = urlParams.get('lang');
        if (urlLang && ['ru','en','es','de','fr','it','ja','zh'].includes(urlLang)) uiLang = urlLang;

        if (cfg?.feedbackEnabled === false || cfg?.disableFeedback === true) feedbackEnabled = false;

        if (cfg?.orderMode === true || cfg?.mode === 'order') orderMode = true;

        if (cfg?.lockNext === false) lockNext = false;

        if (cfg?.tasks && cfg.tasks.length){
          Object.keys(TASKS).forEach(k => delete TASKS[k]);

          cfg.tasks.forEach((t, i) => {
            if (!t) return;

            if (t.type === 'image' && t.image) {
              TASKS[i + 1] = { type: 'image', image: String(t.image).trim() };
              return;
            }

            const q       = (t.question || "").trim();
            const correct = Array.isArray(t.correct) ? t.correct : [];
            const wrong   = Array.isArray(t.wrong)   ? t.wrong   : [];

            const parts = [];
            if (q) parts.push(q);

            const clean = (arr) => (arr || [])
              .map(x => (x ?? '').toString().replace(/\s+/g, ' ').trim())
              .filter(Boolean);

            const correctClean = clean(correct);
            const wrongClean   = clean(wrong);

            if (correctClean.length) {
              const correctMain = correctClean[0];
              const picked = [correctMain];

              const wrongPool = shuffle([...wrongClean]);
              while (picked.length < quizMaxOptions && wrongPool.length) {
                const w = wrongPool.shift();
                if (w && !picked.includes(w)) picked.push(w);
              }

              if (quizUseOtherCorrect) {
                const otherPool = shuffle(correctClean.slice(1));
                while (picked.length < quizMaxOptions && otherPool.length) {
                  const c = otherPool.shift();
                  if (c && !picked.includes(c)) picked.push(c);
                }
              }

              picked.forEach(v => parts.push(v));
            }

            const line = parts.join(" :: ").trim();
            if (line) TASKS[i + 1] = line;
          });
        }

      }catch(e){
        console.warn("JSON load failed", e);
      }
    }

    refreshCounter();
    spawnAll();
    animate();
    window.addEventListener('resize', keepInsideOnResize);
  })();

  function getRootSize() {
    return {
      width:  root.clientWidth  || window.innerWidth,
      height: root.clientHeight || window.innerHeight
    };
  }

  function keepInsideOnResize(){
    const { width: W, height: H } = getRootSize();
    for (const b of bubbles) {
      if (!b.el.parentNode) continue;
      let x = parseFloat(b.el.style.left) || 0;
      let y = parseFloat(b.el.style.top)  || 0;
      const maxX = Math.max(EDGE_PAD, W - BUBBLE_SIZE - EDGE_PAD);
      const maxY = Math.max(EDGE_PAD, H - BUBBLE_SIZE - EDGE_PAD);
      if (x < EDGE_PAD) b.el.style.left = EDGE_PAD + 'px';
      if (y < EDGE_PAD) b.el.style.top  = EDGE_PAD + 'px';
      if (x > maxX) b.el.style.left = maxX + 'px';
      if (y > maxY) b.el.style.top  = maxY + 'px';
    }
  }

  // ‚úÖ —Å–ø–∞–≤–Ω —Å –∞–Ω—Ç–∏-–ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ–º (—á—Ç–æ–±—ã –Ω–µ –∫—É—á–∫–æ–≤–∞–ª–∏—Å—å —Å—Ä–∞–∑—É)
  function findSpawn(maxW, maxH){
    const maxX = Math.max(EDGE_PAD, maxW - BUBBLE_SIZE - EDGE_PAD);
    const maxY = Math.max(EDGE_PAD, maxH - BUBBLE_SIZE - EDGE_PAD);

    for(let attempt=0; attempt<60; attempt++){
      const x = EDGE_PAD + Math.random() * (maxX - EDGE_PAD);
      const y = EDGE_PAD + Math.random() * (maxY - EDGE_PAD);

      let ok = true;
      for(const b of bubbles){
        if(!b.el || !b.el.parentNode) continue;
        const bx = parseFloat(b.el.style.left) || 0;
        const by = parseFloat(b.el.style.top)  || 0;
        const dx = (bx - x), dy = (by - y);
        const d = Math.hypot(dx,dy);
        if (d < SEPARATION_DIST * 0.9) { ok = false; break; }
      }
      if(ok) return {x,y};
    }
    return {
      x: EDGE_PAD + Math.random() * (Math.max(EDGE_PAD, maxW - BUBBLE_SIZE - EDGE_PAD) - EDGE_PAD),
      y: EDGE_PAD + Math.random() * (Math.max(EDGE_PAD, maxH - BUBBLE_SIZE - EDGE_PAD) - EDGE_PAD),
    };
  }

  function spawnAll(){
    const { width: maxW, height: maxH } = getRootSize();
    const totalLocal = Object.keys(TASKS).length;

    for (let i = 1; i <= totalLocal; i++) {
      const el = document.createElement('img');
      el.src = bubbleImg;
      el.style.opacity = '1';
      Object.assign(el.style, {
        position: 'absolute',
        width: BUBBLE_SIZE + 'px',
        height: 'auto',
        objectFit: 'contain',
        pointerEvents: 'auto',
        cursor: 'pointer',
        zIndex: 100,
        transition: 'transform 0.2s ease'
      });

      const p = findSpawn(maxW, maxH);
      el.style.left = p.x + 'px';
      el.style.top  = p.y + 'px';

      // ‚úÖ —Å–ø–æ–∫–æ–π–Ω–∞—è —Å—Ç–∞—Ä—Ç–æ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å (px/sec)
      const angle = Math.random()*Math.PI*2;
      const speed = MIN_SPEED + Math.random()*(MAX_SPEED - MIN_SPEED);
      const vx = Math.cos(angle) * speed;
      const vy = Math.sin(angle) * speed;

      const bubble = {
        el,
        vx, vy,
        id: i,
        seedA: Math.random()*1000,
        seedB: Math.random()*1000,
        hoverFactor: 1,
        hoverTarget: 1
      };
      bubbles.push(bubble);

      el.addEventListener('click', () => {
        if (lockNext && taskOpen) { denyClickFeedback(); return; }

        const pop = new Audio(sounds.pop);
        try { pop.currentTime = 0; pop.play(); } catch(_) {}

        taskOpen = true;
        pendingBubbleEl = el;
        pendingBubbleId = i;

        el.style.pointerEvents = 'none';
        el.style.opacity = '0.35';
        el.style.filter = 'grayscale(1)';

        const sparkle = document.createElement('div');
        sparkle.textContent = '‚ú®';
        Object.assign(sparkle.style, {
          position: 'absolute',
          left: el.style.left,
          top: el.style.top,
          fontSize: '18px',
          zIndex: 150,
          pointerEvents: 'none',
          animation: 'sparkle 0.6s ease-out forwards'
        });
        root.appendChild(sparkle);
        setTimeout(() => sparkle.remove(), 600);

        showMessage(i, finishCurrentTask);
      });

      // ‚úÖ –ø–æ—á—Ç–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏, –≤–æ–∑–≤—Ä–∞—Ç –ø–æ—Å–ª–µ
      el.addEventListener('mouseenter', () => { bubble.hoverTarget = HOVER_FACTOR; });
      el.addEventListener('mouseleave', () => { bubble.hoverTarget = 1; });

      root.appendChild(el);
    }
  }

  function animate() {
    const now = performance.now();
    let dt = (now - lastT) / 1000;
    lastT = now;
    if (!isFinite(dt) || dt <= 0) dt = 0.016;
    dt = Math.min(0.033, dt);

    const { width: W, height: H } = getRootSize();
    const maxX = Math.max(EDGE_PAD, W - BUBBLE_SIZE - EDGE_PAD);
    const maxY = Math.max(EDGE_PAD, H - BUBBLE_SIZE - EDGE_PAD);

    // ‚úÖ –º—è–≥–∫–æ–µ —Ä–∞—Å—Ç–∞–ª–∫–∏–≤–∞–Ω–∏–µ (—á—Ç–æ–±—ã –Ω–µ –∫—É—á–∫–æ–≤–∞–ª–∏—Å—å/–Ω–µ –∑–∞–ª–∏–ø–∞–ª–∏)
    for(let i=0;i<bubbles.length;i++){
      const a = bubbles[i];
      if(!a.el.parentNode) continue;
      const ax = parseFloat(a.el.style.left) || 0;
      const ay = parseFloat(a.el.style.top)  || 0;

      for(let j=i+1;j<bubbles.length;j++){
        const b = bubbles[j];
        if(!b.el.parentNode) continue;
        const bx = parseFloat(b.el.style.left) || 0;
        const by = parseFloat(b.el.style.top)  || 0;

        const dx = bx - ax;
        const dy = by - ay;
        const d = Math.hypot(dx,dy);
        if (d > 0 && d < SEPARATION_DIST){
          const push = (SEPARATION_DIST - d) / SEPARATION_DIST; // 0..1
          const nx = dx / d;
          const ny = dy / d;

          const force = SEPARATION_PUSH * push; // px/sec
          a.vx -= nx * force;
          a.vy -= ny * force;
          b.vx += nx * force;
          b.vy += ny * force;
        }
      }
    }

    for (const b of bubbles) {
      if (!b.el.parentNode) continue;

      // –ø–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ hoverFactor
      b.hoverFactor += (b.hoverTarget - b.hoverFactor) * 0.10;

      let x = parseFloat(b.el.style.left) || 0;
      let y = parseFloat(b.el.style.top)  || 0;

      // ‚úÖ –æ—á–µ–Ω—å –º—è–≥–∫–∞—è "—Ç–µ—á–∫–∞" –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–Ω–µ –¥—ë—Ä–≥–∞–Ω—å–µ)
      const t = now * 0.001;
      const ax = (Math.sin(t*0.55 + b.seedA) + Math.sin(t*0.21 + b.seedB)) * 6; // px/sec^2
      const ay = (Math.cos(t*0.48 + b.seedB) + Math.cos(t*0.19 + b.seedA)) * 6; // px/sec^2

      b.vx = (b.vx + ax * dt) * DAMP;
      b.vy = (b.vy + ay * dt) * DAMP;

      // –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ (—Å–ø–æ–∫–æ–π–Ω–æ)
      const sp = Math.hypot(b.vx, b.vy);
      const maxSp = MAX_SPEED * b.hoverFactor;
      const minSp = MIN_SPEED * b.hoverFactor;
      if (sp > 0){
        if (sp > maxSp){
          b.vx = b.vx / sp * maxSp;
          b.vy = b.vy / sp * maxSp;
        } else if (sp < minSp){
          b.vx = b.vx / sp * minSp;
          b.vy = b.vy / sp * minSp;
        }
      }

      x += b.vx * dt;
      y += b.vy * dt;

      // ‚úÖ –º—è–≥–∫–∏–µ –æ—Ç—Ç–∞–ª–∫–∏–≤–∞–Ω–∏—è –æ—Ç –∫—Ä–∞—ë–≤ "–Ω–µ –¥–æ—Ö–æ–¥—è"
      if (x < EDGE_PAD) { x = EDGE_PAD; b.vx = Math.abs(b.vx) * 0.92; }
      if (x > maxX)     { x = maxX;     b.vx = -Math.abs(b.vx) * 0.92; }
      if (y < EDGE_PAD) { y = EDGE_PAD; b.vy = Math.abs(b.vy) * 0.92; }
      if (y > maxY)     { y = maxY;     b.vy = -Math.abs(b.vy) * 0.92; }

      // –Ω–µ–±–æ–ª—å—à–æ–π "–≤–Ω—É—Ç—Ä—å" –µ—Å–ª–∏ –¥–æ–ª–≥–æ —Ç—Ä—ë—Ç—Å—è –æ –∫—Ä–∞–π
      const edgeBias = 8;
      if (x <= EDGE_PAD + 1) b.vx += edgeBias;
      if (x >= maxX - 1)     b.vx -= edgeBias;
      if (y <= EDGE_PAD + 1) b.vy += edgeBias;
      if (y >= maxY - 1)     b.vy -= edgeBias;

      b.el.style.left = x + 'px';
      b.el.style.top  = y + 'px';
    }

    requestAnimationFrame(animate);
  }

  function shuffle(arr){
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  // ‚úÖ –µ–¥–∏–Ω—ã–π –ø—Ä–æ–∏–≥—Ä—ã–≤–∞—Ç–µ–ª—å (—á—Ç–æ–±—ã –Ω–µ –ø–ª–æ–¥–∏—Ç—å try/catch –≤–µ–∑–¥–µ)
  function playSound(url){
    try{
      if(!url) return;
      const a = new Audio(url);
      a.currentTime = 0;
      a.play().catch(()=>{});
    }catch(_){}
  }

  function launchFirework(anchorEl){
    const r = (anchorEl?.getBoundingClientRect ? anchorEl.getBoundingClientRect() : null);
    const cx = r ? (r.left + r.width/2) : (window.innerWidth/2);
    const cy = r ? (r.top  + r.height/2) : (window.innerHeight/2);

    const symbols = ['üéÜ','üéá','‚ú®','üåü','üí•','üí´'];
    const count = 26;

    for(let i=0;i<count;i++){
      const p = document.createElement('div');
      p.className = 'firework';
      p.textContent = symbols[Math.floor(Math.random()*symbols.length)];

      const angle = Math.random() * Math.PI * 2;
      const dist  = 80 + Math.random()*180;
      const dx = Math.cos(angle) * dist;
      const dy = Math.sin(angle) * dist;

      p.style.left = cx + 'px';
      p.style.top  = cy + 'px';
      p.style.setProperty('--dx', dx + 'px');
      p.style.setProperty('--dy', dy + 'px');

      root.appendChild(p);
      setTimeout(()=>p.remove(), 950);
    }
  }

  function t(key){
    const dict = {
      ru:{inputPlaceholder:'–í–ø–∏—à–∏ –æ—Ç–≤–µ—Ç...', btnOk:'–ì–æ—Ç–æ–≤–æ', done:'–ì–æ—Ç–æ–≤–æ', correct:'‚úÖ –í–µ—Ä–Ω–æ!', wrong:'‚ùå –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑', reset:'–°–±—Ä–æ—Å–∏—Ç—å'},
      en:{inputPlaceholder:'Type the answer...', btnOk:'Done', done:'Done', correct:'‚úÖ Correct!', wrong:'‚ùå Try again', reset:'Reset'},
      es:{inputPlaceholder:'Escribe la respuesta...', btnOk:'Listo', done:'Listo', correct:'‚úÖ ¬°Correcto!', wrong:'‚ùå Int√©ntalo de nuevo', reset:'Restablecer'},
      de:{inputPlaceholder:'Antwort eingeben...', btnOk:'Fertig', done:'Fertig', correct:'‚úÖ Richtig!', wrong:'‚ùå Versuch es noch einmal', reset:'Zur√ºcksetzen'},
      fr:{inputPlaceholder:'√âcris la r√©ponse...', btnOk:'Termin√©', done:'Termin√©', correct:'‚úÖ Correct !', wrong:'‚ùå R√©essaie', reset:'R√©initialiser'},
      it:{inputPlaceholder:'Scrivi la risposta...', btnOk:'Fatto', done:'Fatto', correct:'‚úÖ Corretto!', wrong:'‚ùå Riprova', reset:'Reimposta'},
      ja:{inputPlaceholder:'Á≠î„Åà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ‚Ä¶', btnOk:'ÂÆå‰∫Ü', done:'ÂÆå‰∫Ü', correct:'‚úÖ Ê≠£Ëß£ÔºÅ', wrong:'‚ùå „ÇÇ„ÅÜ‰∏ÄÂ∫¶', reset:'„É™„Çª„ÉÉ„Éà'},
      zh:{inputPlaceholder:'ËØ∑ËæìÂÖ•Á≠îÊ°à‚Ä¶', btnOk:'ÂÆåÊàê', done:'ÂÆåÊàê', correct:'‚úÖ Ê≠£Á°ÆÔºÅ', wrong:'‚ùå ÂÜçËØï‰∏ÄÊ¨°', reset:'ÈáçÁΩÆ'}
    };
    const lang = dict[uiLang] ? uiLang : 'en';
    return dict[lang][key] || key;
  }

  function normSpaces(s){ return String(s||'').replace(/\s+/g,' ').trim(); }
function looksLikeLatex(s){
  s = String(s||'').trim();
  if(!s) return false;

  // –µ—Å–ª–∏ —É–∂–µ —Ä–∞–∑–º–µ—á–µ–Ω–æ ‚Äî –Ω–µ —Ç—Ä–æ–≥–∞–µ–º
  if (s.includes('\\(') || s.includes('\\[')) return false;
  if (s.includes('$') && s.lastIndexOf('$') !== s.indexOf('$')) return false;

  // –µ—Å–ª–∏ –µ—Å—Ç—å —è–≤–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã –º–µ–∂–¥—É —Å–ª–æ–≤–∞–º–∏ ‚Äî —ç—Ç–æ —Ç–µ–∫—Å—Ç
  if (/\s/.test(s)) return false;

  // –µ—Å–ª–∏ —ç—Ç–æ gap: ___ –∏–ª–∏ _ _ _
  if (/^_+$/.test(s)) return false;
  if (/(_\s+_)+/.test(s)) return false;

  // TeX-–∫–æ–º–∞–Ω–¥—ã
  if (/\\[a-zA-Z]+/.test(s)) return true;

  // —Å—Ç–µ–ø–µ–Ω–∏ / –∏–Ω–¥–µ–∫—Å—ã –ë–ï–ó –ø—Ä–æ–±–µ–ª–æ–≤
  // x^2, x^{2}, a_1, a_{n}
  if (/[A-Za-z0-9][\^_](\{[^}]+\}|[A-Za-z0-9]+)/.test(s)) return true;

  return false;
}


function wrapLatexIfNeeded(s){
  s = String(s||'');
  return looksLikeLatex(s) ? `\\(${s.trim()}\\)` : s;
}

  function tokenizeSentence(s){
    const str = String(s||'').trim();
    return (str.match(/[\p{L}\p{M}]+|\p{N}+|[^\s]/gu) || []);
  }
  function joinTokens(tokens){
    const noSpaceBefore = new Set([',','.',':',';','!','?','‚Ä¶',')',']','}','¬ª','‚Äù','ÔºÖ','%']);
    const noSpaceAfter  = new Set(['(','[','{','¬´','‚Äú']);
    let out = '';
    for (let i=0;i<tokens.length;i++){
      const tok = tokens[i];
      const prev = tokens[i-1];
      if (i===0) { out += tok; continue; }
      if (noSpaceBefore.has(tok)) { out += tok; continue; }
      if (noSpaceAfter.has(prev)) { out += tok; continue; }
      out += ' ' + tok;
    }
    return out;
  }

  function makeTaskCardBase(){
    const msg = document.createElement('div');
    Object.assign(msg.style, {
      position: 'absolute',
      top: '50%',
      left: '50%',
      transform: 'translate(-50%, -50%)',
      background: 'linear-gradient(135deg, #4facfe, #00f2fe)',
      color: 'white',
      padding: '24px 36px',
      borderRadius: '20px',
      fontSize: '22px',
      fontFamily: 'sans-serif',
      textAlign: 'left',
      boxShadow: '0 6px 16px rgba(0,0,0,0.3)',
      pointerEvents: 'auto',
      zIndex: 200,
    });

    if (styleTask){
      if (styleTask.bgColor) applyBgWithOpacity(msg, styleTask.bgColor, (typeof styleTask.opacity === 'number' ? styleTask.opacity : 1));
      if (styleTask.borderColor) msg.style.border = '2px solid ' + styleTask.borderColor;

      if (styleTask.fontSize) msg.style.fontSize = styleTask.fontSize + 'px';
      if (styleTask.textColor) msg.style.color = styleTask.textColor;
      else if (styleTask.color) msg.style.color = styleTask.color;

      if (styleTask.neon) {
        const glow = styleTask.borderColor || '#ffffff';
        msg.style.boxShadow = `0 0 18px ${glow}`;
      }
    }

    return msg;
  }

  // ----------------------
  // ORDER MODE ‚Äî –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ —Å–ª–æ–≤ (–∏–∫–æ–Ω–∫–∏ —Å–ª–µ–≤–∞/—Å–ø—Ä–∞–≤–∞, —Ü–µ–Ω—Ç—Ä –ø–æ –≤—ã—Å–æ—Ç–µ)
  // ----------------------
  function showOrderSentence(sentence, onDone){
    sentence = wrapLatexIfNeeded(sentence);
    const originalTokens = tokenizeSentence(sentence);
    const target = joinTokens(originalTokens);

    const msg = makeTaskCardBase();
    msg.style.textAlign = 'center';
    msg.style.boxSizing = 'border-box';
    msg.style.width = 'calc(100vw - 40px)';
    msg.style.maxWidth = 'calc(100vw - 40px)';
    msg.style.display = 'flex';
    msg.style.flexDirection = 'column';
    msg.style.alignItems = 'center';
    msg.style.gap = '10px';
    msg.style.overflow = 'visible';
    msg.style.paddingLeft = '18px';
    msg.style.paddingRight = '18px';
    msg.style.paddingTop = '16px';
    msg.style.paddingBottom = '16px';

    const chipsWrap = document.createElement('div');
    Object.assign(chipsWrap.style, {
      display: 'flex',
      flexWrap: 'wrap',
      justifyContent: 'center',
      alignItems: 'center',
      gap: '10px',
      padding: '10px 56px',        // –º–µ—Å—Ç–æ –ø–æ–¥ –∏–∫–æ–Ω–∫–∏ —Å–ª–µ–≤–∞/—Å–ø—Ä–∞–≤–∞
      borderRadius: '16px',
      background: 'rgba(0,0,0,0.18)',
      boxSizing: 'border-box',
      width: '100%',
      maxWidth: '100%',
      overflow: 'visible'
    });

    let dragSrcIndex = null;

    function makeChip(text){
      const chip = document.createElement('div');
      chip.textContent = text;
      Object.assign(chip.style, {
        padding: '10px 16px',
        borderRadius: '999px',
        background: 'rgba(255,255,255,0.95)',
        color: '#2d3436',
        fontWeight: '700',
        fontSize: 'inherit',
        boxShadow: '0 4px 10px rgba(0,0,0,0.25)',
        userSelect: 'none',
        cursor: 'grab',
        whiteSpace: 'nowrap',
        transform: 'translateZ(0)',
        transition: 'transform 0.12s ease, box-shadow 0.12s ease'
      });
      chip.setAttribute('draggable', 'true');

      chip.addEventListener('dragstart', () => {
        dragSrcIndex = Array.from(chipsWrap.children).indexOf(chip);
        chip.style.opacity = '0.6';
        chip.style.transform = 'scale(0.96)';
      });

      chip.addEventListener('dragend', () => {
        chip.style.opacity = '1';
        chip.style.transform = 'scale(1)';
      });

      chip.addEventListener('dragover', (e) => {
        e.preventDefault();
        chip.style.boxShadow = '0 0 0 3px rgba(255,255,255,0.6)';
      });

      chip.addEventListener('dragleave', () => {
        chip.style.boxShadow = '0 4px 10px rgba(0,0,0,0.25)';
      });

      chip.addEventListener('drop', (e) => {
        e.preventDefault();
        chip.style.boxShadow = '0 4px 10px rgba(0,0,0,0.25)';

        if (dragSrcIndex === null) return;

        const children = Array.from(chipsWrap.children);
        const src = children[dragSrcIndex];
        const tgtIndex = children.indexOf(chip);
        if (!src || tgtIndex === -1 || src === chip) {
          dragSrcIndex = null;
          return;
        }

        if (dragSrcIndex < tgtIndex) chipsWrap.insertBefore(src, chip.nextSibling);
        else chipsWrap.insertBefore(src, chip);

        dragSrcIndex = null;
      });

      chip.addEventListener('mousedown', () => {
        chip.style.transform = 'scale(0.97)';
        chip.style.cursor = 'grabbing';
      });
      chip.addEventListener('mouseup', () => {
        chip.style.transform = 'scale(1)';
        chip.style.cursor = 'grab';
      });

      return chip;
    }

    shuffle([...originalTokens]).forEach(tok => chipsWrap.appendChild(makeChip(tok)));

    // ‚úÖ –ó–û–ù–ê: —á–∏–ø—ã + –∏–∫–æ–Ω–∫–∏ —Å–ª–µ–≤–∞/—Å–ø—Ä–∞–≤–∞, —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –≤—ã—Å–æ—Ç–µ —Ä–∞–º–∫–∏
    const chipsZone = document.createElement('div');
    Object.assign(chipsZone.style, {
      position: 'relative',
      width: '100%',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center'
    });

    function makeIconButton(symbol, side){
      const b = document.createElement('button');
      b.type = 'button';
      b.innerHTML = symbol;
      Object.assign(b.style, {
        position: 'absolute',
        top: '50%',
        transform: 'translateY(-50%)',
        width: '30px',
        height: '30px',
        borderRadius: '999px',
        border: '1px solid rgba(255,255,255,0.18)',
        display: 'grid',
        placeItems: 'center',
        cursor: 'pointer',
        userSelect: 'none',
        lineHeight: '1',
        fontSize: '16px',
        fontWeight: '900',
        padding: '0',
        background: 'rgba(0,0,0,0.28)',
        color: '#fff',
        boxShadow: '0 10px 22px rgba(0,0,0,0.22)',
        backdropFilter: 'blur(6px)',
        transition: 'transform .15s ease, box-shadow .15s ease, filter .15s ease'
      });
      if (side === 'left') b.style.left = '12px';
      if (side === 'right') b.style.right = '12px';

      b.addEventListener('mouseenter', () => {
        b.style.transform = 'translateY(-50%) scale(1.08)';
        b.style.boxShadow = '0 14px 28px rgba(0,0,0,0.30)';
        b.style.filter = 'brightness(1.08)';
      });
      b.addEventListener('mouseleave', () => {
        b.style.transform = 'translateY(-50%) scale(1)';
        b.style.boxShadow = '0 10px 22px rgba(0,0,0,0.22)';
        b.style.filter = 'none';
      });
      b.addEventListener('mousedown', () => {
        b.style.transform = 'translateY(-50%) scale(0.96)';
      });
      b.addEventListener('mouseup', () => {
        b.style.transform = 'translateY(-50%) scale(1.08)';
      });

      return b;
    }

    const resetIcon = makeIconButton('‚Ü∫', 'left');
    const doneIcon  = makeIconButton('‚úì', 'right');

    chipsZone.appendChild(chipsWrap);
    chipsZone.appendChild(resetIcon);
    chipsZone.appendChild(doneIcon);

    const fb = document.createElement('div');
    fb.style.minHeight = '24px';
    fb.style.fontWeight = '800';
    fb.style.textAlign = 'center';
    fb.style.marginTop = '6px';

    function currentAnswer(){
      const toks = Array.from(chipsWrap.children).map(el => el.textContent);
      return joinTokens(toks);
    }

    resetIcon.addEventListener('click', () => {
      chipsWrap.innerHTML = '';
      shuffle([...originalTokens]).forEach(tok => chipsWrap.appendChild(makeChip(tok)));
      fb.textContent = '';
    });

    doneIcon.addEventListener('click', () => {
      const got = normSpaces(currentAnswer());
      const want = normSpaces(target);
      if (!got) return;

      if (got === want) {
        fb.textContent = t('correct');
        playSound(sounds.correct);          // ‚úÖ –∑–≤—É–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ç–æ–ª—å–∫–æ —Ç—É—Ç
        launchFirework(msg);
        setTimeout(() => {
          msg.remove();
          onDone && onDone();
        }, 450);
      } else {
        fb.textContent = t('wrong');
        playSound(sounds.wrong);            // ‚úÖ –∑–≤—É–∫ –æ—à–∏–±–∫–∞ —Ç–æ–ª—å–∫–æ —Ç—É—Ç
      }
    });

    msg.appendChild(chipsZone);
    msg.appendChild(fb);

    if (window.MathJax && window.MathJax.typesetPromise) {
      window.MathJax.typesetPromise([msg]).catch(() => {});
    }

    root.appendChild(msg);
    if (window.MathJax?.typesetPromise) {
  MathJax.typesetPromise([msg]).catch(()=>{});
}
  }

  function showMessage(id, onDone) {
    const raw = TASKS[id] || "";

    if (raw && typeof raw === 'object' && raw.type === 'image' && raw.image) {
      const wrap = document.createElement('div');
      Object.assign(wrap.style, {
        position:'absolute', top:'50%', left:'50%', transform:'translate(-50%, -50%)',
        zIndex:200, pointerEvents:'auto',
        borderRadius:'18px', padding:'14px',
        boxShadow: styleTask?.neon ? ('0 0 18px ' + (styleTask.borderColor || '#fff')) : '0 6px 16px rgba(0,0,0,0.3)'
      });
      if (styleTask?.bgColor) applyBgWithOpacity(wrap, styleTask.bgColor, (typeof styleTask.opacity === 'number' ? styleTask.opacity : 1));
      else wrap.style.background = 'rgba(0,0,0,0.55)';
      if (styleTask?.borderColor) wrap.style.border = '2px solid ' + styleTask.borderColor;

      const img = document.createElement('img');
      img.src = raw.image;
      Object.assign(img.style, { maxWidth:'75vw', maxHeight:'75vh', borderRadius:'14px', display:'block' });
      wrap.appendChild(img);

      const doneBtn = document.createElement('button');
      doneBtn.className = 'kgb-btn';
      doneBtn.textContent = t('done');

      Object.assign(doneBtn.style,{
        marginTop:'12px',
        padding:'10px 18px',
        borderRadius:'999px',
        border:'none',
        cursor:'pointer',
        fontWeight:'900',
        fontSize:'inherit'
      });
      wrap.appendChild(doneBtn);

      doneBtn.addEventListener('click', () => {
        wrap.remove();
        onDone && onDone();
      });

      root.appendChild(wrap);
      return;
    }

    // ‚úÖ order-mode —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –∑–∞–¥–∞—á –±–µ–∑ "::"
    if (orderMode && typeof raw === 'string' && raw && !raw.includes('::')) {
      showOrderSentence(raw, onDone);
      return;
    }

    // ‚õî –ö–í–ò–ó / –í–ü–ò–°–ê–¢–¨ ‚Äî –û–°–¢–ê–í–õ–Ø–ï–ú –ö–ê–ö –ï–°–¢–¨ (–±–µ–∑ —Ç–≤–æ–∏—Ö –Ω–æ–≤—ã—Ö –∑–≤—É–∫–æ–≤ –∏ —à–∏—Ä–∏–Ω)
    const parts = String(raw).split("::");
    const question = wrapLatexIfNeeded((parts[0] || raw).trim());

    const options = parts.slice(1).map(s => s.trim()).filter(Boolean);

    const msg = makeTaskCardBase();
    msg.style.textAlign = 'center';

    const q = document.createElement('div');
    q.className = 'task-question';
    q.innerHTML = question || `<b>Task ${id}</b>`;
    q.style.marginBottom = '16px';
    q.style.fontWeight = '900';
    msg.appendChild(q);

    if (options.length === 0) {
      const doneBtn = document.createElement('button');
      doneBtn.textContent = t('done');
      Object.assign(doneBtn.style, {
        padding: '10px 18px',
        borderRadius: '999px',
        border: 'none',
        fontSize: 'inherit',
        fontWeight: '900',
        cursor: 'pointer',
        background: 'rgba(255,255,255,0.92)',
        color: '#2d3436'
      });
      doneBtn.addEventListener('click', () => {
        msg.remove();
        onDone && onDone();
      });
      msg.appendChild(doneBtn);

    } else if (options.length === 1) {
      const correct = options[0].toLowerCase();

      const input = document.createElement('input');
      Object.assign(input.style, {
        width: '100%',
        padding: '10px 12px',
        borderRadius: '12px',
        border: 'none',
        marginBottom: '10px',
        fontSize: 'inherit',
        fontWeight: '700',
        color: '#2d3436'
      });
      input.placeholder = t('inputPlaceholder');
      msg.appendChild(input);

      const btn = document.createElement('button');
      btn.className = 'kgb-btn';
      btn.textContent = t('btnOk');

      Object.assign(btn.style, {
        padding: '10px 18px',
        borderRadius: '999px',
        border: 'none',
        fontSize: 'inherit',
        fontWeight: '900',
        cursor: 'pointer',
        background: 'rgba(255,255,255,0.92)',
        color: '#2d3436',
        marginBottom: '8px'
      });
      msg.appendChild(btn);

      const fb = document.createElement('div');
      fb.style.minHeight = '28px';
      fb.style.fontWeight = '900';
      msg.appendChild(fb);

     function checkAnswer() {
  const value = (input.value || '').trim().toLowerCase();
  if (!value) return;

  if (value === correct) {
    fb.textContent = t('correct');
    playSound(sounds.correct);      // ‚úÖ –∑–≤—É–∫ "–≤–µ—Ä–Ω–æ"
    launchFirework(msg);
    setTimeout(() => {
      msg.remove();
      onDone && onDone();
    }, 450);
  } else {
    fb.textContent = t('wrong');
    playSound(sounds.wrong);        // ‚úÖ –∑–≤—É–∫ "–æ—à–∏–±–∫–∞"
  }
}


      btn.addEventListener('click', checkAnswer);
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') checkAnswer();
      });

    } else {
      const correct = options[0];
      const shuffled = shuffle([...options]);

      const list = document.createElement('div');
      list.style.display = 'flex';
      list.style.flexDirection = 'column';
      list.style.gap = '10px';
      list.style.marginTop = '8px';

      shuffled.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = 'kgb-btn';
        btn.textContent = opt;

        Object.assign(btn.style, {
          padding: '12px 14px',
          borderRadius: '999px',
          border: 'none',
          fontSize: 'inherit',
          fontWeight: '900',
          cursor: 'pointer',
          background: 'rgba(255,255,255,0.92)',
          color: '#2d3436'
        });
       btn.addEventListener('click', () => {
  if (opt === correct) {
    btn.style.background = '#00b894';
    btn.style.color = '#fff';
    playSound(sounds.correct);      // ‚úÖ –∑–≤—É–∫ "–≤–µ—Ä–Ω–æ"
    launchFirework(msg);
    setTimeout(() => {
      msg.remove();
      onDone && onDone();
    }, 450);
  } else {
    btn.style.background = '#d63031';
    btn.style.color = '#fff';
    playSound(sounds.wrong);        // ‚úÖ –∑–≤—É–∫ "–æ—à–∏–±–∫–∞"
  }
});

        list.appendChild(btn);
      });

      msg.appendChild(list);
    }

   
    root.appendChild(msg);
     if (window.MathJax?.typesetPromise) {
  MathJax.typesetPromise([msg]).catch(()=>{});
}
  }

  // ----------------------
  // –§–ò–ù–ê–õ–¨–ù–´–ô –§–ò–î–ë–ï–ö
  // ----------------------
  function showFinal() {
    if (!feedbackEnabled) return;
    try { counter.remove(); } catch(_){}

    const overlay = document.createElement('div');
    Object.assign(overlay.style, {
      position: 'fixed',
      inset: '0',
      zIndex: 400,
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      pointerEvents: 'auto',
      animation: 'popUp .7s ease-out forwards'
    });

    const wrap = document.createElement('div');
    Object.assign(wrap.style, {
      display: 'flex',
      flexDirection: 'column',
      alignItems: 'center',
      gap: '14px',
      maxWidth: '80vw',
      maxHeight: '85vh',
      pointerEvents: 'auto'
    });

    overlay.appendChild(wrap);
    document.body.appendChild(overlay);

    const label = document.createElement('div');
   label.innerHTML = wrapLatexIfNeeded(finalText || 'üéâ Well done!');

    Object.assign(label.style, {
      padding: '14px 26px',
      borderRadius: '16px',
      fontWeight: '900',
      textAlign: 'center',
      maxWidth: '80vw',
      wordBreak: 'break-word',
      color: '#fff',
      background: 'rgba(0,0,0,0.72)',
      fontSize: (styleTask?.fontSize ? styleTask.fontSize + 'px' : '28px'),
      boxShadow: '0 8px 20px rgba(0,0,0,.3)',
      border: '2px solid rgba(255,255,255,.18)',
      pointerEvents: 'none',
      animation: 'popUp .7s ease-out forwards'
    });

    if (styleFeedback) {
      if (styleFeedback.bgColor) label.style.background = styleFeedback.bgColor;
      if (styleFeedback.borderColor) label.style.border = '2px solid ' + styleFeedback.borderColor;
      if (styleFeedback.textColor) label.style.color = styleFeedback.textColor;
      if (styleFeedback.fontSize) label.style.fontSize = styleFeedback.fontSize + 'px';
      if (styleFeedback.neon) {
        const glow = styleFeedback.borderColor || '#fff';
        label.style.boxShadow = `0 0 20px ${glow}`;
      }
    }

    wrap.appendChild(label);

    const chest = document.createElement('img');
    chest.src = feedbackImage || 'https://i.postimg.cc/prHF0XG1/AI-(4).gif';
    Object.assign(chest.style, {
      display: 'block',
      maxWidth: '70vw',
      maxHeight: '55vh',
      width: 'auto',
      height: 'auto',
      objectFit: 'contain',
      cursor: 'pointer',
      animation: 'fadeIn .8s ease-out',
      transition: 'transform .4s ease',
      filter: 'drop-shadow(0 16px 28px rgba(0,0,0,.35))'
    });
    wrap.appendChild(chest);

    const openSound = new Audio(sounds.open);

    chest.addEventListener('click', () => {
      chest.style.transform = 'scale(1.08)';
      openSound.play().catch(() => {});

      for (let i = 0; i < 40; i++) {
        const s = document.createElement('div');
        s.textContent = ['‚ú®','üí´','üåü','üîÆ'][Math.floor(Math.random() * 4)];
        s.style.setProperty('--dx', (Math.random() - 0.5) * 220 + 'px');
        s.style.setProperty('--dy', (Math.random() - 0.5) * 220 + 'px');
        Object.assign(s.style, {
          position: 'fixed',
          left: '50%',
          top: '50%',
          transform: `translate(-50%,-50%) scale(${Math.random() * .6 + .6})`,
          fontSize: (Math.random() * 20 + 10) + 'px',
          opacity: .8,
          animation: 'sparkFly 1.4s ease-out forwards',
          zIndex: 999,
          pointerEvents: 'none'
        });
        document.body.appendChild(s);
        setTimeout(() => s.remove(), 1500);
      }

      if (window.MathJax?.typesetPromise) {
        window.MathJax.typesetPromise([label]).catch(() => {});
      }
    });

    if (window.MathJax?.typesetPromise) {
      window.MathJax.typesetPromise([label]).catch(() => {});
    }
  }

})();
  </script>
</body>
</html>
