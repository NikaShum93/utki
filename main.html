<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>–°–≤–µ—Ç–ª—è—á–∫–∏</title>

  <!-- MathJax –¥–ª—è —Ñ–æ—Ä–º—É–ª -->
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: transparent;
    }
    #bubble-extension {
      position: absolute;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      pointer-events: auto; overflow: hidden;
      z-index: 999999;
    }

    /* HUD counter with icon */
    #counter { display:inline-flex; align-items:center; gap:8px; }
    #counter .icon {
      width:26px; height:26px;
      background-size:contain; background-repeat:no-repeat; background-position:center;
      border-radius:6px; filter:drop-shadow(0 0 6px rgba(0,0,0,.2));
    }

    /* –í—Å–ø—ã—à–∫–∏ –æ—Ç –ø—É–∑—ã—Ä–µ–π */
    @keyframes sparkle {
      0% { opacity: 0; transform: scale(0.5); }
      50% { opacity: 1; transform: scale(1.2); }
      100% { opacity: 0; transform: scale(0.5); }
    }

    .bit{
      position:absolute; width:6px; height:6px; pointer-events:none; z-index:350;
      background:radial-gradient(circle at 30% 30%, #fff, rgba(255,255,255,.7) 40%, rgba(255,255,255,0) 70%);
      border-radius:50%; box-shadow:0 0 6px rgba(255,255,255,.45);
      animation:scatter .7s ease-out forwards;
    }
    @keyframes scatter{
      from{opacity:1; transform:translate(0,0) scale(1)}
      to  {opacity:0; transform:translate(var(--tx),var(--ty)) scale(.4)}
    }

    /* –ö–æ–Ω—Ñ–µ—Ç—Ç–∏ —Å—Ç–∞—Ä–æ–µ (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ) */
    @keyframes confetti {
      0% { opacity: 0; transform: scale(0.7) rotate(-10deg); }
      50% { opacity: 1; transform: scale(1.2) rotate(15deg); }
      100% { opacity: 0; transform: scale(0.7) rotate(-10deg); }
    }

    /* –í—ã–ª–µ—Ç —Ñ–∏–¥–±–µ–∫–∞ */
    @keyframes popUp {
      0% { opacity: 0; transform: translate(-50%, -30%) scale(0.5); }
      60% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }

    /* –†–∞–∑–ª–µ—Ç –±–ª—ë—Å—Ç–æ–∫ –æ—Ç —Å—É–Ω–¥—É–∫–∞ */
    @keyframes sparkFly {
      0% { opacity: 1; transform: translate(-50%, -50%) scale(0.8); }
      100% {
        opacity: 0;
        transform: translate(
          calc(-50% + (var(--dx))),
          calc(-50% + (var(--dy)))
        ) scale(0.4);
      }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
      to   { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    }
  </style>
</head>
<body>
  <div id="bubble-extension"></div>

  <script>
(function(){
  const root = document.getElementById('bubble-extension');
  const urlParams = new URLSearchParams(window.location.search);

  // –ì–¥–µ –ª–µ–∂–∞—Ç JSON –æ—Ç —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
  const JSON_BASE = "https://nikashum93.github.io/texts/data/";
  const cfgId = urlParams.get('id');

  // –ö–æ–Ω—Ñ–∏–≥ –∏–∑ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
  let feedbackImage = "";
  let sounds = {
    pop:  "https://nikashum93.github.io/utki/pop.mp3",
    open: "https://nikashum93.github.io/utki/open.mp3"
  };
  let styleTask = null;
  let styleFeedback = null;
  let uiLang = 'ru';           // 'ru','en','es','de','fr','it','ja','zh'
  let feedbackEnabled = true;  // –º–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–∏–¥–±–µ–∫
  let orderMode = false;       // —Ä–µ–∂–∏–º ¬´—Å–æ–±–µ—Ä–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ¬ª –¥–ª—è –≤—Å–µ—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –∑–∞–¥–∞–Ω–∏–π


  // —Ç–æ, —á—Ç–æ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è—Ç—å —á–µ—Ä–µ–∑ URL (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
  let finalText = decodeURIComponent(urlParams.get('final') || "üéâ Well Done!");
  let bubbleImg = decodeURIComponent(urlParams.get('img')   || "https://media.tenor.com/_-Y9OYD_cWwAAAAi/duck-bwong.gif");

  function setCounterIcon(url){
    try{
      const el = document.querySelector('#counter .icon');
      if (el) el.style.backgroundImage = url ? `url(${url})` : 'none';
    }catch(_){}
  }

  const isCustomImg = !!urlParams.get('img');

  // –ó–∞–¥–∞—á–∏ (—Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç —á–µ—Ä–µ–∑ URL —Ç–æ–∂–µ –ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞–µ–º)
  const TASKS = {};
  for (let [key, value] of urlParams.entries()) {
    if (key.startsWith('task')) {
      const id = parseInt(key.replace('task', ''));
      TASKS[id] = decodeURIComponent(value);
    }
  }

  // –°–æ—Å—Ç–æ—è–Ω–∏—è
  let total = 0;
  let popped = 0;
  let finalUnlocked = false;
  const bubbles = [];
  const BUBBLE_SIZE = 80;

  // HUD-—Å—á—ë—Ç—á–∏–∫
  const counter = document.createElement('div');
  counter.id = 'counter';
  const counterIcon = document.createElement('span'); counterIcon.className='icon';
  const counterTxt  = document.createElement('span'); counterTxt.className='txt';
  counter.appendChild(counterIcon);
  counter.appendChild(counterTxt);
  Object.assign(counter.style, {
    position: 'absolute',
    top: '20px',
    left: '20px',
    background: 'linear-gradient(135deg, #f6f9fc, #dff9fb)',
    padding: '10px 16px',
    borderRadius: '12px',
    fontFamily: 'sans-serif',
    fontSize: '18px',
    color: '#2d3436',
    boxShadow: '0 4px 12px rgba(0,0,0,0.1)',
    zIndex: 300,
    pointerEvents: 'none'
  });
  root.appendChild(counter);

  function refreshCounter(){
    total = Object.keys(TASKS).length;
    setCounterIcon(bubbleImg);
    counterTxt.innerHTML = `<strong>${popped} / ${total}</strong>`;
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: —Ç—è–Ω–µ–º JSON, –µ—Å–ª–∏ –µ—Å—Ç—å id
  (async function init(){
    if (cfgId){
      try{
        const res = await fetch(`${JSON_BASE}${encodeURIComponent(cfgId)}.json?v=${Date.now()}`, { cache:'no-store' });
        const cfg = await res.json();
      let quizMaxOptions = 4;
let quizUseOtherCorrect = false;
          if (typeof cfg?.quizMaxOptions === 'number') {
  quizMaxOptions = Math.max(2, Math.min(10, Math.floor(cfg.quizMaxOptions)));
}
if (cfg?.quizUseOtherCorrect === true) {
  quizUseOtherCorrect = true;
}
        // –ö–∞—Ä—Ç–∏–Ω–∫–∞ —Å–≤–µ—Ç–ª—è—á–∫–æ–≤
        if (cfg?.style?.bgImage) bubbleImg = cfg.style.bgImage;

        // –ò—Ç–æ–≥–æ–≤—ã–π —Ç–µ–∫—Å—Ç
        if (typeof cfg?.finalFeedback === 'string') finalText = cfg.finalFeedback;

        // –ö–∞—Ä—Ç–∏–Ω–∫–∞ —Ñ–∏–¥–±–µ–∫–∞ (—Å—É–Ω–¥—É–∫ / —á—Ç–æ —É–≥–æ–¥–Ω–æ)
        if (cfg?.feedbackImage) feedbackImage = cfg.feedbackImage;

        // –ó–≤—É–∫–∏ –∏–∑ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
        if (cfg?.sounds?.pop)  sounds.pop  = cfg.sounds.pop;
        if (cfg?.sounds?.open) sounds.open = cfg.sounds.open;

        // –°—Ç–∏–ª–∏ –∑–∞–¥–∞–Ω–∏—è / —Ñ–∏–¥–±–µ–∫–∞
        if (cfg?.style?.task)     styleTask     = cfg.style.task;
        if (cfg?.style?.feedback) styleFeedback = cfg.style.feedback;

        // –Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        if (cfg?.lang && ['ru','en','es','de','fr','it','ja','zh'].includes(cfg.lang)) uiLang = cfg.lang;
        if (cfg?.language && ['ru','en','es','de','fr','it','ja','zh'].includes(cfg.language)) uiLang = cfg.language;
        const urlLang = urlParams.get('lang');
        if (urlLang && ['ru','en','es','de','fr','it','ja','zh'].includes(urlLang)) uiLang = urlLang;

        // –ú–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–∏–¥–±–µ–∫
        if (cfg?.feedbackEnabled === false || cfg?.disableFeedback === true) feedbackEnabled = false;

        // –†–µ–∂–∏–º ¬´—Å–æ–±–µ—Ä–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ¬ª (–≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ—Å—Ç—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –∑–∞–¥–∞–Ω–∏–π)
        if (cfg?.orderMode === true || cfg?.mode === 'order') orderMode = true;


               // –ó–∞–¥–∞—á–∏ –∏–∑ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞: tasks: [{ question, correct:[], wrong:[] }]
        if (cfg?.tasks && cfg.tasks.length){
          // –æ—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ TASKS (–∑–∞–¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ URL)
          Object.keys(TASKS).forEach(k => delete TASKS[k]);

          cfg.tasks.forEach((t, i) => {
            if (!t) return;

            // –ó–∞–¥–∞–Ω–∏–µ-–∫–∞—Ä—Ç–∏–Ω–∫–∞ (PNG/GIF –ø–æ —Å—Å—ã–ª–∫–µ)
            if (t.type === 'image' && t.image) {
              TASKS[i + 1] = { type: 'image', image: String(t.image).trim() };
              return;
            }


            const q       = (t.question || "").trim();
            const correct = Array.isArray(t.correct) ? t.correct : [];
            const wrong   = Array.isArray(t.wrong)   ? t.wrong   : [];

            // —Ñ–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ –¥–≤–∏–∂–∫–∞:
            // 1) –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç        ‚Üí "—Ç–µ–∫—Å—Ç"
            // 2) –≤–ø–∏—Å–∞—Ç—å –æ—Ç–≤–µ—Ç       ‚Üí "–≤–æ–ø—Ä–æ—Å :: –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π"
            // 3) –∫–≤–∏–∑                ‚Üí "–≤–æ–ø—Ä–æ—Å :: –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π :: –Ω–µ–≤–µ—Ä–Ω—ã–π1 :: –Ω–µ–≤–µ—Ä–Ω—ã–π2..."
            const parts = [];

            if (q) parts.push(q);

          // --- —Å—Ç—Ä–æ–∏–º –≤–∞—Ä–∏–∞–Ω—Ç—ã –∫–≤–∏–∑–∞ —Å –ª–∏–º–∏—Ç–æ–º ---
const clean = (arr) => (arr || [])
  .map(x => (x ?? '').toString().replace(/\s+/g, ' ').trim())
  .filter(Boolean);

const correctClean = clean(correct);
const wrongClean   = clean(wrong);

if (correctClean.length) {
  const correctMain = correctClean[0];

  // —Å–æ–±–∏—Ä–∞–µ–º –ø—É–ª –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤: 1 –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π + (wrong) + (–¥—Ä—É–≥–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–æ –≥–∞–ª–æ—á–∫–µ)
  const picked = [correctMain];

  // 1) —Å–Ω–∞—á–∞–ª–∞ –¥–æ–±–∏—Ä–∞–µ–º –∏–∑ wrong
  const wrongPool = shuffle([...wrongClean]);
  while (picked.length < quizMaxOptions && wrongPool.length) {
    const w = wrongPool.shift();
    if (w && !picked.includes(w)) picked.push(w);
  }

  // 2) –µ—Å–ª–∏ –Ω–µ —Ö–≤–∞—Ç–∏–ª–æ –∏ –≤–∫–ª—é—á—ë–Ω –¥–æ–±–æ—Ä ‚Äî –¥–æ–±–∏—Ä–∞–µ–º –∏–∑ –¥—Ä—É–≥–∏—Ö correct
  if (quizUseOtherCorrect) {
    const otherPool = shuffle(correctClean.slice(1));
    while (picked.length < quizMaxOptions && otherPool.length) {
      const c = otherPool.shift();
      if (c && !picked.includes(c)) picked.push(c);
    }
  }

  // –í–ê–ñ–ù–û: —Ñ–æ—Ä–º–∞—Ç –¥–≤–∏–∂–∫–∞ = "–≤–æ–ø—Ä–æ—Å :: –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π :: –≤–∞—Ä–∏–∞–Ω—Ç—ã..."
  // –∏ –ø–µ—Ä–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –ø–æ—Å–ª–µ –≤–æ–ø—Ä–æ—Å–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º
  picked.forEach(v => parts.push(v));
} else {
  // –µ—Å–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –Ω–µ—Ç ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç/–≤–æ–ø—Ä–æ—Å –±–µ–∑ –æ—Ç–≤–µ—Ç–æ–≤
  // (–æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –±—ã–ª–æ: parts —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç question, –¥–∞–ª—å—à–µ –Ω–∏—á–µ–≥–æ)
}

// –µ—Å–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –±—ã–ª, –Ω–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –≤—ã—à–ª–æ 1 ‚Äî –ø–æ–ª—É—á–∏—Ç—Å—è input (–≤–æ–ø—Ä–æ—Å :: –æ—Ç–≤–µ—Ç)
// –µ—Å–ª–∏ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ >=2 ‚Äî –ø–æ–ª—É—á–∏—Ç—Å—è quiz (–≤–æ–ø—Ä–æ—Å :: –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π :: ...)

const line = parts.join(" :: ").trim();
if (line) {
  TASKS[i + 1] = line;
}
          });
        }

      }catch(e){
        console.warn("JSON load failed", e);
      }
    }

    refreshCounter();
    spawnAll();
    animate();
    window.addEventListener('resize', keepInsideOnResize);
  })();

  function getRootSize() {
    return {
      width:  root.clientWidth  || window.innerWidth,
      height: root.clientHeight || window.innerHeight
    };
  }

  function keepInsideOnResize(){
    const { width: W, height: H } = getRootSize();
    for (const b of bubbles) {
      if (!b.el.parentNode) continue;
      let x = parseFloat(b.el.style.left) || 0;
      let y = parseFloat(b.el.style.top)  || 0;
      if (x > W - BUBBLE_SIZE) b.el.style.left = (W - BUBBLE_SIZE) + 'px';
      if (y > H - BUBBLE_SIZE) b.el.style.top  = (H - BUBBLE_SIZE) + 'px';
    }
  }

  function spawnAll(){
    const { width: maxW, height: maxH } = getRootSize();
    const totalLocal = Object.keys(TASKS).length;

    for (let i = 1; i <= totalLocal; i++) {
      const el = document.createElement('img');
      el.src = bubbleImg;
      el.style.opacity = isCustomImg ? '1' : '1';
      Object.assign(el.style, {
        position: 'absolute',
        width: BUBBLE_SIZE + 'px',
        height: 'auto',
        objectFit: 'contain',
        pointerEvents: 'auto',
        cursor: 'pointer',
        zIndex: 100,
        transition: 'transform 0.2s ease'
      });

      el.style.left = (Math.random() * (maxW - BUBBLE_SIZE)) + 'px';
      el.style.top  = (Math.random() * (maxH - BUBBLE_SIZE)) + 'px';

      const dx = (Math.random()*2 - 1) * 1.5;
      const dy = (Math.random()*2 - 1) * 1.5;
      const bubble = { el, dx, dy, id: i };
      bubbles.push(bubble);

      el.addEventListener('click', () => {
        const pop = new Audio(sounds.pop);
        try { pop.currentTime = 0; pop.play(); } catch(_) {}

        el.remove();
        showMessage(i);
        popped++;
        refreshCounter();

        // –º–∏–Ω–∏-–≤—Å–ø—ã—à–∫–∞
        const sparkle = document.createElement('div');
        sparkle.textContent = '‚ú®';
        Object.assign(sparkle.style, {
          position: 'absolute',
          left: el.style.left,
          top: el.style.top,
          fontSize: '18px',
          zIndex: 150,
          pointerEvents: 'none',
          animation: 'sparkle 0.6s ease-out forwards'
        });
        root.appendChild(sparkle);
        setTimeout(() => sparkle.remove(), 600);
      });

      el.addEventListener('mouseenter', () => {
        bubble.dx *= 0.2;
        bubble.dy *= 0.2;
      });
      el.addEventListener('mouseleave', () => {
        bubble.dx *= 5;
        bubble.dy *= 5;
      });

      root.appendChild(el);
    }
  }

  function animate() {
    const { width: W, height: H } = getRootSize();
    for (const b of bubbles) {
      if (!b.el.parentNode) continue;
      let x = parseFloat(b.el.style.left) || 0;
      let y = parseFloat(b.el.style.top)  || 0;

      x += b.dx;
      y += b.dy;

      // –û—Ç—Å–∫–æ–∫–∏
      if (x < 0) { x = 0; b.dx = -b.dx + (Math.random() - 0.5) * 0.4; }
      if (x > W - BUBBLE_SIZE) { x = W - BUBBLE_SIZE; b.dx = -b.dx + (Math.random() - 0.5) * 0.4; }
      if (y < 0) { y = 0; b.dy = -b.dy + (Math.random() - 0.5) * 0.4; }
      if (y > H - BUBBLE_SIZE) { y = H - BUBBLE_SIZE; b.dy = -b.dy + (Math.random() - 0.5) * 0.4; }

      // –ß—Ç–æ–±—ã –Ω–µ –∑–∞–ª–∏–ø–∞–ª–∏
      if (Math.abs(b.dx) < 0.3) b.dx += (Math.random() - 0.5) * 0.5;
      if (Math.abs(b.dy) < 0.3) b.dy += (Math.random() - 0.5) * 0.5;

      b.dx = Math.max(-1.5, Math.min(1.5, b.dx));
      b.dy = Math.max(-1.5, Math.min(1.5, b.dy));

      b.el.style.left = x + 'px';
      b.el.style.top  = y + 'px';
    }
    requestAnimationFrame(animate);
  }

  function shuffle(arr){
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function t(key){
    const dict = {
      ru:{inputPlaceholder:'–í–ø–∏—à–∏ –æ—Ç–≤–µ—Ç...', btnOk:'OK', correct:'‚úÖ –í–µ—Ä–Ω–æ!', wrong:'‚ùå –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑', reset:'–°–±—Ä–æ—Å–∏—Ç—å'},
      en:{inputPlaceholder:'Type the answer...', btnOk:'OK', correct:'‚úÖ Correct!', wrong:'‚ùå Try again', reset:'Reset'},
      es:{inputPlaceholder:'Escribe la respuesta...', btnOk:'OK', correct:'‚úÖ ¬°Correcto!', wrong:'‚ùå Int√©ntalo de nuevo', reset:'Restablecer'},
      de:{inputPlaceholder:'Antwort eingeben...', btnOk:'OK', correct:'‚úÖ Richtig!', wrong:'‚ùå Versuch es noch einmal', reset:'Zur√ºcksetzen'},
      fr:{inputPlaceholder:'√âcris la r√©ponse...', btnOk:'OK', correct:'‚úÖ Correct !', wrong:'‚ùå R√©essaie', reset:'R√©initialiser'},
      it:{inputPlaceholder:'Scrivi la risposta...', btnOk:'OK', correct:'‚úÖ Corretto!', wrong:'‚ùå Riprova', reset:'Reimposta'},
      ja:{inputPlaceholder:'Á≠î„Åà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ‚Ä¶', btnOk:'OK', correct:'‚úÖ Ê≠£Ëß£ÔºÅ', wrong:'‚ùå „ÇÇ„ÅÜ‰∏ÄÂ∫¶', reset:'„É™„Çª„ÉÉ„Éà'},
      zh:{inputPlaceholder:'ËØ∑ËæìÂÖ•Á≠îÊ°à‚Ä¶', btnOk:'OK', correct:'‚úÖ Ê≠£Á°ÆÔºÅ', wrong:'‚ùå ÂÜçËØï‰∏ÄÊ¨°', reset:'ÈáçÁΩÆ'}
    };
    const lang = dict[uiLang] ? uiLang : 'en';
    return dict[lang][key] || key;
  }

  function normSpaces(s){ return String(s||'').replace(/\s+/g,' ').trim(); }

  // —Ç–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–ª—è —Ä–µ–∂–∏–º–∞ ¬´—Å–æ–±–µ—Ä–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É¬ª
  function tokenizeSentence(s){
    const str = String(s||'').trim();
    return (str.match(/[\p{L}\p{M}]+|\p{N}+|[^\s]/gu) || []);
  }
  function joinTokens(tokens){
    const noSpaceBefore = new Set([',','.',':',';','!','?','‚Ä¶',')',']','}','¬ª','‚Äù','ÔºÖ','%']);
    const noSpaceAfter  = new Set(['(','[','{','¬´','‚Äú']);
    let out = '';
    for (let i=0;i<tokens.length;i++){
      const tok = tokens[i];
      const prev = tokens[i-1];
      if (i===0) { out += tok; continue; }
      if (noSpaceBefore.has(tok)) { out += tok; continue; }
      if (noSpaceAfter.has(prev)) { out += tok; continue; }
      out += ' ' + tok;
    }
    return out;
  }

  // ----------------------
  // –û–ö–ù–û –ó–ê–î–ê–ù–ò–Ø
  // –§–æ—Ä–º–∞—Ç —Å—Ç—Ä–æ–∫–∏:
  // 1) "–ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç" ‚Üí –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑–∞–ª–∏, –∑–∞–∫—Ä—ã–ª–∏ –ø–æ –∫–ª–∏–∫—É
  // 2) "–≤–æ–ø—Ä–æ—Å :: –æ—Ç–≤–µ—Ç" ‚Üí —Ä–µ–∂–∏–º "–≤–ø–∏—Å–∞—Ç—å –æ—Ç–≤–µ—Ç"
  // 3) "–≤–æ–ø—Ä–æ—Å :: –≤–∞—Ä–∏–∞–Ω—Ç1 :: –≤–∞—Ä–∏–∞–Ω—Ç2 :: ..." ‚Üí –∫–≤–∏–∑, –ø–µ—Ä–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç = –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
  // ----------------------
  function showOrderSentence(sentence){
    const originalTokens = tokenizeSentence(sentence);
    const target = joinTokens(originalTokens);

    const msg = document.createElement('div');
    Object.assign(msg.style, {
      position:'absolute',
      top:'50%', left:'50%',
      transform:'translate(-50%, -50%)',
      background:'linear-gradient(135deg, #4facfe, #00f2fe)',
      color:'white',
      padding:'20px 22px',
      borderRadius:'20px',
      fontSize:'22px',
      fontFamily:'sans-serif',
      textAlign:'center',
      boxShadow:'0 6px 16px rgba(0,0,0,0.3)',
      pointerEvents:'auto',
      zIndex:200,
      maxWidth:'80vw'
    });

    // —Å—Ç–∏–ª–∏ –∏–∑ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
    if (styleTask){
      if (styleTask.bgColor) msg.style.background = styleTask.bgColor;
      if (styleTask.borderColor) msg.style.border = '2px solid ' + styleTask.borderColor;
      if (typeof styleTask.opacity === 'number') msg.style.opacity = styleTask.opacity;
      if (styleTask.fontSize) msg.style.fontSize = styleTask.fontSize + 'px';
      if (styleTask.textColor) msg.style.color = styleTask.textColor;
      else if (styleTask.color) msg.style.color = styleTask.color;
      if (styleTask.neon){
        const glow = styleTask.borderColor || '#ffffff';
        msg.style.boxShadow = `0 0 18px ${glow}`;
      }
    }

    const title = document.createElement('div');
    title.style.marginBottom = '12px';
    title.style.fontWeight = '700';
    title.innerHTML = sentence;
    msg.appendChild(title);

    const answer = document.createElement('div');
    Object.assign(answer.style, {
      display:'flex', flexWrap:'wrap', gap:'8px', justifyContent:'center',
      padding:'10px', borderRadius:'14px', background:'rgba(0,0,0,0.18)',
      marginBottom:'10px', minHeight:'44px'
    });

    const bank = document.createElement('div');
    Object.assign(bank.style, {
      display:'flex', flexWrap:'wrap', gap:'8px', justifyContent:'center',
      padding:'10px', borderRadius:'14px', background:'rgba(255,255,255,0.16)'
    });

    const makeChip = (text) => {
      const chip = document.createElement('button');
      chip.type = 'button';
      chip.textContent = text;
      Object.assign(chip.style, {
        border:'none', borderRadius:'999px',
        padding:'8px 12px',
        fontSize:'16px',
        cursor:'pointer',
        background:'rgba(255,255,255,0.92)',
        color:'#2d3436'
      });
      return chip;
    };

    const shuffled = shuffle([...originalTokens]);
    shuffled.forEach(tok => {
      const chip = makeChip(tok);
      chip.addEventListener('click', () => {
        answer.appendChild(chip);
        checkDone();
      });
      bank.appendChild(chip);
    });

    const fb = document.createElement('div');
    fb.style.marginTop = '10px';
    fb.style.minHeight = '24px';
    fb.style.fontWeight = '700';

    const resetBtn = document.createElement('button');
    resetBtn.textContent = t('reset');
    Object.assign(resetBtn.style, {
      marginTop:'10px',
      padding:'8px 16px',
      borderRadius:'999px',
      border:'none',
      cursor:'pointer',
      background:'rgba(0,0,0,0.25)',
      color:'inherit',
      fontWeight:'700'
    });

    resetBtn.addEventListener('click', () => {
      const chips = Array.from(answer.querySelectorAll('button'));
      chips.forEach(ch => bank.appendChild(ch));
      fb.textContent = '';
    });

    function currentAnswer(){
      const toks = Array.from(answer.querySelectorAll('button')).map(b => b.textContent);
      return joinTokens(toks);
    }

    function checkDone(){
      const toks = Array.from(answer.querySelectorAll('button'));
      if (toks.length !== originalTokens.length) return;

      const got = normSpaces(currentAnswer());
      const want = normSpaces(target);
      if (got === want){
        fb.textContent = t('correct');
        setTimeout(() => {
          msg.remove();
          if (popped === total && !finalUnlocked) { finalUnlocked = true; showFinal(); }
        }, 500);
      } else {
        fb.textContent = t('wrong');
      }
    }

    msg.appendChild(answer);
    msg.appendChild(bank);
    msg.appendChild(resetBtn);
    msg.appendChild(fb);

    if (window.MathJax && window.MathJax.typesetPromise) {
      window.MathJax.typesetPromise([msg]).catch(() => {});
    }

    root.appendChild(msg);
  }

  function showMessage(id) {
    const raw = TASKS[id] || "";
    // –ó–∞–¥–∞–Ω–∏–µ-–∫–∞—Ä—Ç–∏–Ω–∫–∞ (PNG/GIF): TASKS[id] = {type:'image', image:'...'}
    if (raw && typeof raw === 'object' && raw.type === 'image' && raw.image) {
      const wrap = document.createElement('div');
      Object.assign(wrap.style, {
        position:'absolute', top:'50%', left:'50%', transform:'translate(-50%, -50%)',
        zIndex:200, pointerEvents:'auto',
        background: (styleTask?.bgColor || 'rgba(0,0,0,0.55)'),
        border: styleTask?.borderColor ? ('2px solid ' + styleTask.borderColor) : 'none',
        borderRadius:'18px', padding:'14px',
        boxShadow: styleTask?.neon ? ('0 0 18px ' + (styleTask.borderColor || '#fff')) : '0 6px 16px rgba(0,0,0,0.3)'
      });
      const img = document.createElement('img');
      img.src = raw.image;
      Object.assign(img.style, { maxWidth:'75vw', maxHeight:'75vh', borderRadius:'14px', display:'block' });
      wrap.appendChild(img);
      wrap.addEventListener('click', () => {
        wrap.remove();
        if (popped === total && !finalUnlocked) { finalUnlocked = true; showFinal(); }
      });
      root.appendChild(wrap);
      return;
    }

    // –†–µ–∂–∏–º ¬´—Å–æ–±–µ—Ä–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ¬ª: –ª—é–±–æ–µ –ø—Ä–æ—Å—Ç–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ (–±–µ–∑ ::) –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º –≤ —Å–±–æ—Ä–∫—É —Å–ª–æ–≤
    if (orderMode && typeof raw === 'string' && raw && !raw.includes('::')) {
      showOrderSentence(raw);
      return;
    }

    const parts = raw.split("::");
    const question = (parts[0] || raw).trim();
    const options = parts.slice(1).map(s => s.trim()).filter(Boolean);

    const msg = document.createElement('div');
    Object.assign(msg.style, {
      position: 'absolute',
      top: '50%',
      left: '50%',
      transform: 'translate(-50%, -50%)',
      background: 'linear-gradient(135deg, #4facfe, #00f2fe)',
      color: 'white',
      padding: '24px 36px',
      borderRadius: '20px',
      fontSize: '22px',
      fontFamily: 'sans-serif',
      textAlign: 'center',
      boxShadow: '0 6px 16px rgba(0,0,0,0.3)',
      pointerEvents: 'auto',
      zIndex: 200,
      maxWidth: '70vw'
    });

    // –ø—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ –∑–∞–¥–∞–Ω–∏—è –∏–∑ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
    if (styleTask){
      if (styleTask.bgColor) {
        msg.style.background = styleTask.bgColor;
      }
      if (styleTask.borderColor) {
        msg.style.border = '2px solid ' + styleTask.borderColor;
      }
      if (typeof styleTask.opacity === 'number') {
        msg.style.opacity = styleTask.opacity;
      }
      if (styleTask.fontSize) {
        msg.style.fontSize = styleTask.fontSize + 'px';
      // —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ –∑–∞–¥–∞–Ω–∏—è
      if (styleTask.textColor) { msg.style.color = styleTask.textColor; }
      else if (styleTask.color) { msg.style.color = styleTask.color; }
      }
      if (styleTask.neon) {
        const glow = styleTask.borderColor || '#ffffff';
        msg.style.boxShadow = `0 0 18px ${glow}`;
      }
    }

    // –í–æ–ø—Ä–æ—Å
    const q = document.createElement('div');
    q.className = 'task-question';
    q.innerHTML = question || `<b>Task ${id}</b>`;
    q.style.marginBottom = '16px';
    msg.appendChild(q);

    if (options.length === 0) {
      // –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç ‚Üí –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ –∫–ª–∏–∫—É
      msg.style.cursor = 'pointer';
      msg.addEventListener('click', () => {
        msg.remove();
        if (popped === total && !finalUnlocked) {
          finalUnlocked = true;
          showFinal();
        }
      });
    } else if (options.length === 1) {
      // üìù –í–ü–ò–°–ê–¢–¨ –û–¢–í–ï–¢
      const correct = options[0].toLowerCase();

      const input = document.createElement('input');
      Object.assign(input.style, {
        width: '100%',
        padding: '8px 10px',
        borderRadius: '10px',
        border: 'none',
        marginBottom: '10px',
        fontSize: '18px',
        color: '#2d3436'
      });
      input.placeholder = t('inputPlaceholder');
      msg.appendChild(input);

      const btn = document.createElement('button');
      btn.textContent = t('btnOk');
      Object.assign(btn.style, {
        padding: '8px 18px',
        borderRadius: '999px',
        border: 'none',
        fontSize: '16px',
        fontWeight: 'bold',
        cursor: 'pointer',
        background: '#fff',
        color: '#0984e3',
        marginBottom: '8px'
      });
      msg.appendChild(btn);

      const fb = document.createElement('div');
      fb.style.minHeight = '24px';
      msg.appendChild(fb);

      function checkAnswer() {
        const value = (input.value || '').trim().toLowerCase();
        if (!value) return;
        if (value === correct) {
          fb.textContent = t('correct');
          setTimeout(() => {
            msg.remove();
            if (popped === total && !finalUnlocked) {
              finalUnlocked = true;
              showFinal();
            }
          }, 500);
        } else {
          fb.textContent = t('wrong');
        }
      }

      btn.addEventListener('click', checkAnswer);
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') checkAnswer();
      });

    } else {
      // ‚ùì –ö–í–ò–ó: –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤, –ø–µ—Ä–≤—ã–π = –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
      const correct = options[0];
      const shuffled = shuffle([...options]);

      const list = document.createElement('div');
      list.style.display = 'flex';
      list.style.flexDirection = 'column';
      list.style.gap = '8px';
      list.style.marginTop = '8px';

      shuffled.forEach(opt => {
        const btn = document.createElement('button');
        btn.textContent = opt;
        Object.assign(btn.style, {
          padding: '8px 10px',
          borderRadius: '999px',
          border: 'none',
          fontSize: '16px',
          cursor: 'pointer',
          background: 'rgba(255,255,255,0.9)',
          color: '#2d3436'
        });
        btn.addEventListener('click', () => {
          if (opt === correct) {
            btn.style.background = '#00b894';
            btn.style.color = '#fff';
            setTimeout(() => {
              msg.remove();
              if (popped === total && !finalUnlocked) {
                finalUnlocked = true;
                showFinal();
              }
            }, 500);
          } else {
            btn.style.background = '#d63031';
            btn.style.color = '#fff';
          }
        });
        list.appendChild(btn);
      });

      msg.appendChild(list);
    }

    // MathJax –¥–ª—è –≤–æ–ø—Ä–æ—Å–∞/–≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
    if (window.MathJax && window.MathJax.typesetPromise) {
      window.MathJax.typesetPromise([msg]).catch(() => {});
    }

    root.appendChild(msg);
  }

  // ----------------------
  // –§–ò–ù–ê–õ–¨–ù–´–ô –§–ò–î–ë–ï–ö (—Å—É–Ω–¥—É–∫ / —Å–≤–æ—è –∫–∞—Ä—Ç–∏–Ω–∫–∞)
  // ----------------------
  function showFinal() {
    if (!feedbackEnabled) return;
    try { counter.remove(); } catch(_){}

    const chest = document.createElement('img');
    chest.src = feedbackImage || 'https://img.genially.com/64233afb55129a0017751c8e/915b9b98-7a24-4b3f-887a-28042ba9acca.png';
    Object.assign(chest.style, {
      position: 'absolute',
      top: '50%',
      left: '50%',
      transform: 'translate(-50%, -50%) scale(1)',
      width: '240px',
      cursor: 'pointer',
      zIndex: 300,
      pointerEvents: 'auto',
      transition: 'transform 0.4s ease',
      animation: 'fadeIn 0.8s ease-out'
    });
    root.appendChild(chest);

    const openSound = new Audio(sounds.open);

    chest.addEventListener('click', () => {
      chest.src = feedbackImage || 'https://img.genially.com/64233afb55129a0017751c8e/d76550fd-2622-441f-bbf2-faee6906772e.png';
      chest.style.transform = 'translate(-50%, -50%) scale(1.1)';
      openSound.play().catch(() => {});

      // –ë–ª—ë—Å—Ç–∫–∏
      for (let i = 0; i < 40; i++) {
        const sparkle = document.createElement('div');
        sparkle.textContent = ['‚ú®', 'üí´', 'üåü', 'üîÆ'][Math.floor(Math.random() * 4)];
        const dx = (Math.random() - 0.5) * 220;
        const dy = (Math.random() - 0.5) * 220;
        sparkle.style.setProperty('--dx', dx + 'px');
        sparkle.style.setProperty('--dy', dy + 'px');

        Object.assign(sparkle.style, {
          position: 'absolute',
          left: '50%',
          top: '50%',
          transform: `translate(-50%, -50%) scale(${Math.random() * 0.6 + 0.6})`,
          fontSize: `${Math.random() * 20 + 10}px`,
          opacity: '0.8',
          animation: 'sparkFly 1.4s ease-out forwards',
          zIndex: 350,
          pointerEvents: 'none'
        });
        root.appendChild(sparkle);
        setTimeout(() => sparkle.remove(), 1500);
      }

      // –¢–µ–∫—Å—Ç —Ñ–∏–¥–±–µ–∫–∞
          const label = document.createElement('div');
      label.innerHTML = finalText || 'üéâ Well done!';
      Object.assign(label.style, {
        position: 'absolute',
        // –ø–æ–¥–Ω–∏–º–∞–µ–º —Ç–µ–∫—Å—Ç –≤—ã—à–µ, —á—Ç–æ–±—ã –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–ª –∫–∞—Ä—Ç–∏–Ω–∫—É
        top: '18%',
        left: '50%',
        transform: 'translate(-50%, -50%) scale(0.85)',
        fontSize: '28px',
        fontWeight: 'bold',
        color: '#fff',
        padding: '14px 26px',
        background: 'linear-gradient(135deg, #e67e22, #f1c40f)',
        borderRadius: '16px',
        fontFamily: 'Comic Sans MS, sans-serif',
        boxShadow: '0 8px 20px rgba(0,0,0,0.3)',
        zIndex: 400,
        pointerEvents: 'none',
        textShadow: '2px 2px 6px rgba(0,0,0,0.4)',
        animation: 'popUp 0.7s ease-out forwards',
        maxWidth: '70vw'
      });

      // –ø—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ —Ñ–∏–¥–±–µ–∫–∞ –∏–∑ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
      if (styleFeedback){
        if (styleFeedback.borderColor) {
          label.style.border = '2px solid ' + styleFeedback.borderColor;
        }
        if (styleFeedback.textColor) {
          label.style.color = styleFeedback.textColor;
        if (styleFeedback.bgColor) { label.style.background = styleFeedback.bgColor; }
        }
        if (styleFeedback.neon) {
          const glow = styleFeedback.borderColor || '#ffffff';
          label.style.boxShadow = `0 0 20px ${glow}`;
        }
      }

      root.appendChild(label);

      // MathJax –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
      if (window.MathJax && window.MathJax.typesetPromise) {
        window.MathJax.typesetPromise([label]).catch(() => {});
      }
    });
  }

})();
  </script>
</body>
</html>
