<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–†–µ–¥–∞–∫—Ç–æ—Ä ‚Äî Utki</title>
  <style>
    :root{
      --ui-acc:#ffd700;
      --card:#151515;
      --ink:#eee;
      --muted:#b7b7b7;
      --stroke:#2a2a2a;
      --gap:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:#0d0d0d; color:var(--ink);
      font-family:Rubik,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      display:flex; flex-direction:column;
    }
    header{
      display:flex; align-items:center; gap:12px; padding:16px 20px; border-bottom:1px solid var(--stroke);
      position:sticky; top:0; background:#0d0d0d; z-index:2;
    }
    header h1{font-size:20px; margin:0; color:var(--ui-acc); font-weight:800}
    main{
      display:grid; grid-template-columns: 480px 1fr;
      gap:22px; padding:20px; max-width:1500px; width:100%; margin:0 auto;
    }
    .card{
      background:var(--card); border:1px solid var(--stroke); border-radius:14px;
      padding:18px; box-shadow:0 0 28px rgba(255,215,0,.06);
    }
    .card h2{margin:0 0 14px; font-size:18px; color:var(--ui-acc)}
    label{display:block; margin:12px 0 8px; font-size:15px; color:#fff; font-weight:600}
    input[type=text], input[type=number], input[type=url], textarea, select{
      width:100%; background:#101010; color:#fff; border:1px solid #3a3a3a;
      border-radius:10px; padding:10px 12px; font-size:15px;
      outline:none; transition:border-color .15s ease, box-shadow .15s ease;
    }
    textarea{min-height:80px; resize:vertical}
    input:focus, textarea:focus, select:focus{
      border-color:#4b4b4b; box-shadow:0 0 0 3px rgba(255,215,0,.16);
    }
    .row{display:grid; grid-template-columns:1fr 1fr; gap:var(--gap)}
    .result{
      display:grid; grid-template-columns:1fr auto; gap:12px; align-items:start;
    }
    .result textarea{
      height:120px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:13px;
    }
    .hint{color:var(--muted); font-size:13px; margin-top:6px}
    button{
      background:linear-gradient(90deg,#ffbf00,#ffd700); color:#000; border:none;
      border-radius:12px; font-weight:800;
      padding:12px 16px; cursor:pointer;
      transition:transform .15s ease, box-shadow .15s ease; font-size:15px;
    }
    button:hover{transform:translateY(-1px); box-shadow:0 8px 26px rgba(255,215,0,.28)}
    .btn-ghost{background:transparent; color:#fff; border:1px solid #444}
    .small-hint{font-size:12px; color:var(--muted); margin-top:2px}
  </style>
  <link id="gf" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap">
</head>
<body>
  <header><h1>–†–µ–¥–∞–∫—Ç–æ—Ä ¬´Utki¬ª</h1></header>
  <main>
    <section class="card">
      <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>

      <label>–Ø–∑—ã–∫</label>
      <select id="language"></select>

      <label>–®—Ä–∏—Ñ—Ç</label>
      <select id="font"></select>

      <label>–ö–∞—Ä—Ç–∏–Ω–∫–∞ –ª–µ—Ç–∞—é—â–µ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞ (URL)</label>
      <input type="url" id="bgImage" placeholder="https://.../duck.gif">

      <label>–§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç</label>
      <input type="text" id="finalFeedback" placeholder="üéâ Well Done!">

      <label>–ö–∞—Ä—Ç–∏–Ω–∫–∞ —Ñ–∏–¥–±–µ–∫–∞ (URL)</label>
      <input type="url" id="feedbackImage" placeholder="https://.../chest.png">

      <h2 style="margin-top:14px">üîä –ó–≤—É–∫–∏</h2>
      <label>–ó–≤—É–∫ –ª–æ–ø–∞–Ω–∏—è (URL)</label>
      <input type="url" id="popSound" placeholder="https://.../pop.mp3">

      <label>–ó–≤—É–∫ —Ñ–∏–¥–±–µ–∫–∞ / —Å—É–Ω–¥—É–∫–∞ (URL)</label>
      <input type="url" id="openSound" placeholder="https://.../open.mp3">

      <label>–ó–≤—É–∫ –æ—à–∏–±–∫–∏ (URL, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
      <input type="url" id="wrongSound" placeholder="https://.../wrong.mp3">

      <h2 style="margin-top:14px">üéØ –ó–∞–¥–∞–Ω–∏—è</h2>

      <label>–í–æ–ø—Ä–æ—Å—ã (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫–µ)</label>
      <textarea id="questions" placeholder="–°–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç 2+2?&#10;–ù–∞–π–¥–∏ –∑–Ω–∞—á–µ–Ω–∏–µ x –≤ —É—Ä–∞–≤–Ω–µ–Ω–∏–∏ ..."></textarea>

      <label>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞–±–æ—Ä—É –Ω–∞ —Å—Ç—Ä–æ–∫–µ)</label>
      <textarea id="correctAnswers" placeholder="4|—á–µ—Ç—ã—Ä–µ&#10;x=3|3"></textarea>
      <div class="small-hint">–ù–∞ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–µ ‚Äî –æ—Ç–≤–µ—Ç—ã –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞, –≤–∞—Ä–∏–∞–Ω—Ç—ã —á–µ—Ä–µ–∑ |. –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –±–µ–∑ –æ—Ç–≤–µ—Ç–∞.</div>

      <label>–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞–±–æ—Ä—É –Ω–∞ —Å—Ç—Ä–æ–∫–µ)</label>
      <textarea id="wrongAnswers" placeholder="3|5&#10;x=1|1"></textarea>
      <div class="small-hint">–ù–∞ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–µ ‚Äî –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æe –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞, –≤–∞—Ä–∏–∞–Ω—Ç—ã —á–µ—Ä–µ–∑ |. –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º.</div>

      <label style="margin-top:10px;">
        <input type="checkbox" id="autoDistractors">
        –ë—Ä–∞—Ç—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –∏–∑ –¥—Ä—É–≥–∏—Ö –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö
      </label>
      <div class="small-hint">
        –ï—Å–ª–∏ –¥–ª—è –∑–∞–¥–∞–Ω–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω—ã wrong-–≤–∞—Ä–∏–∞–Ω—Ç—ã, –ø–ª–∞–≥–∏–Ω –ø–æ–¥–º–µ—à–∞–µ—Ç distractors –∏–∑ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –¥—Ä—É–≥–∏—Ö –∑–∞–¥–∞—á.
      </div>

      <h2 style="margin-top:16px">üé® –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</h2>

      <div class="row">
        <div>
          <label>–¶–≤–µ—Ç —Ñ–æ–Ω–∞</label>
          <input type="color" id="taskBgColor" value="#4facfe">
        </div>
        <div>
          <label>–¶–≤–µ—Ç —Ä–∞–º–∫–∏</label>
          <input type="color" id="taskBorderColor" value="#00f2fe">
        </div>
      </div>

      <div class="row">
        <div>
          <label>–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞</label>
          <input type="color" id="taskTextColor" value="#ffffff">
        </div>
        <div>
          <label>–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å (0‚Äì1)</label>
          <input type="number" id="taskBgOpacity" value="1" step="0.1" min="0" max="1">
        </div>
      </div>

      <div class="row">
        <div>
          <label>–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞</label>
          <input type="number" id="taskFontSize" value="22" min="10" max="50">
        </div>
        <div style="display:flex; align-items:flex-end;">
          <label style="margin:0;">
            <input type="checkbox" id="taskNeon"> –ù–µ–æ–Ω–æ–≤–∞—è —Ä–∞–º–∫–∞ –∑–∞–¥–∞–Ω–∏—è
          </label>
        </div>
      </div>

      <h2 style="margin-top:16px">üí´ –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —Ñ–∏–¥–±–µ–∫–∞</h2>

      <div class="row">
        <div>
          <label>–¶–≤–µ—Ç —Ä–∞–º–∫–∏</label>
          <input type="color" id="feedbackBorderColor" value="#e67e22">
        </div>
        <div>
          <label>–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞</label>
          <input type="color" id="feedbackTextColor" value="#ffffff">
        </div>
      </div>

      <label style="margin-top:10px;">
        <input type="checkbox" id="feedbackNeon"> –ù–µ–æ–Ω–æ–≤–∞—è —Ä–∞–º–∫–∞ —Ñ–∏–¥–±–µ–∫–∞
      </label>

      <h2 style="margin-top:16px">üöÄ –ü—É–±–ª–∏–∫–∞—Ü–∏—è</h2>
      <div class="row">
        <button id="saveBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø–æ–ª—É—á–∏—Ç—å iframe</button>
        <button id="testBtn" class="btn-ghost">üîç –í–∞–ª–∏–¥–∞—Ü–∏—è JSON</button>
      </div>
      <div class="result" style="margin-top:10px">
        <textarea id="iframeOut" readonly placeholder="–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è iframe –¥–ª—è Genially"></textarea>
        <button id="copyBtn" class="btn-ghost">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
      <div class="hint">–ü–æ—Å–ª–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –ø–æ–¥–æ–∂–¥–∏—Ç–µ 30‚Äì60 —Å–µ–∫—É–Ω–¥ (–∫–µ—à GitHub Pages).</div>
    </section>

    <section class="card">
      <h2>üß™ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h2>
      <div id="preview" style="display:flex; align-items:center; gap:12px;">
        <div id="iconPrev"
             style="width:36px; height:36px; background:#222; border-radius:8px;
                    background-size:contain; background-position:center; background-repeat:no-repeat;">
        </div>
        <div id="textPrev" style="font-weight:800; font-size:22px;">0 / 0</div>
      </div>
      <div class="hint">
        –ò–∫–æ–Ω–∫–∞ –≤ —Å—á—ë—Ç—á–∏–∫–µ –±–µ—Ä—ë—Ç—Å—è –∏–∑ –ø–æ–ª—è ¬´–ö–∞—Ä—Ç–∏–Ω–∫–∞ –ª–µ—Ç–∞—é—â–µ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞¬ª.<br>
        –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á ‚Äî –ø–æ —á–∏—Å–ª—É —Å—Ç—Ä–æ–∫ –≤ –ø–æ–ª–µ ¬´–í–æ–ø—Ä–æ—Å—ã¬ª.
      </div>
    </section>
  </main>

  <script>
    const $ = s => document.querySelector(s);

    const ENDPOINT    = "https://server-kjnn.onrender.com/publish";
    const PUBLISH_KEY = "nika_read_pub_2025";
    const BASE_MAIN   = "https://nikashum93.github.io/utki/main.html";

    // –Ø–∑—ã–∫–∏ –∏ —à—Ä–∏—Ñ—Ç—ã
    const LANGUAGE_OPTIONS = [
      { value: "ru", label: "–†—É—Å—Å–∫–∏–π" },
      { value: "en", label: "English" },
      { value: "es", label: "Espa√±ol" },
      { value: "de", label: "Deutsch" },
      { value: "fr", label: "Fran√ßais" },
      { value: "zh", label: "‰∏≠Êñá" },
      { value: "ja", label: "Êó•Êú¨Ë™û" }
    ];

    const FONT_MAP = {
      ru: ["Rubik","PT Sans","Montserrat","Noto Sans"],
      en: ["Inter","Poppins","Roboto","Open Sans","Rubik"],
      es: ["Poppins","Montserrat","Noto Sans","Open Sans"],
      de: ["Fira Sans","Montserrat","Noto Sans","Open Sans"],
      fr: ["Poppins","Montserrat","Noto Sans","Open Sans"],
      zh: ["Noto Sans SC","Noto Serif SC"],
      ja: ["Noto Sans JP","Noto Serif JP"]
    };

    function fillLanguageSelect(){
      const sel = $('#language');
      sel.innerHTML = "";
      LANGUAGE_OPTIONS.forEach(opt => {
        const o = document.createElement('option');
        o.value = opt.value;
        o.textContent = opt.label;
        sel.appendChild(o);
      });
      sel.value = 'ru';
    }

    function fillFontsForLanguage(lang){
      const sel = $('#font');
      sel.innerHTML = "";
      const list = FONT_MAP[lang] || FONT_MAP.en;
      list.forEach(f => {
        const opt = document.createElement('option');
        opt.textContent = f;
        opt.value = f;
        sel.appendChild(opt);
      });
      sel.value = list[0];
      applyGoogleFont(sel.value);
    }

    function applyGoogleFont(fontName){
      if(!fontName) return;
      const gf = document.getElementById('gf');
      const family = fontName.replace(/ /g, '+');
      gf.href = `https://fonts.googleapis.com/css2?family=${family}:wght@400;700&display=swap`;
      document.body.style.fontFamily = fontName + ', system-ui, sans-serif';
    }

    function collectConfig(){
      const lang = $('#language').value;
      const font = $('#font').value;
      const bgImage = $('#bgImage').value.trim();
      const finalFeedback = $('#finalFeedback').value.trim();
      const feedbackImage = $('#feedbackImage').value.trim();

      const popSoundUrl   = $('#popSound').value.trim()   || 'https://nikashum93.github.io/utki/pop.mp3';
      const openSoundUrl  = $('#openSound').value.trim()  || 'https://nikashum93.github.io/utki/open.mp3';
      const wrongSoundUrl = $('#wrongSound').value.trim(); // –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º

      // –í–æ–ø—Ä–æ—Å—ã / –æ—Ç–≤–µ—Ç—ã
      const qLines  = $('#questions').value.split('\n');
      const cLines  = $('#correctAnswers').value.split('\n');
      const wLines  = $('#wrongAnswers').value.split('\n');

      const maxLen = Math.max(qLines.length, cLines.length, wLines.length);
      const tasks = [];

      for (let i=0; i<maxLen; i++){
        const q = (qLines[i] || '').trim();
        const cRaw = (cLines[i] || '').trim();
        const wRaw = (wLines[i] || '').trim();

        if (!q && !cRaw && !wRaw) continue;

        const correct = cRaw
          ? cRaw.split('|').map(s=>s.trim()).filter(Boolean)
          : [];
        const wrong = wRaw
          ? wRaw.split('|').map(s=>s.trim()).filter(Boolean)
          : [];

        tasks.push({ question: q, correct, wrong });
      }

      const taskBgColor    = $('#taskBgColor').value;
      const taskBorderColor= $('#taskBorderColor').value;
      const taskTextColor  = $('#taskTextColor').value;
      const taskBgOpacity  = parseFloat($('#taskBgOpacity').value) || 1;
      const taskFontSize   = parseInt($('#taskFontSize').value) || 22;
      const taskNeon       = $('#taskNeon').checked;

      const feedbackBorderColor = $('#feedbackBorderColor').value;
      const feedbackTextColor   = $('#feedbackTextColor').value;
      const feedbackNeon        = $('#feedbackNeon').checked;

      const autoDistractors = $('#autoDistractors').checked;

      return {
        language: lang,
        font,
        sounds: {
          pop:  popSoundUrl,
          open: openSoundUrl,
          wrong: wrongSoundUrl
        },
        style: {
          bgImage,
          task: {
            bgColor:    taskBgColor,
            borderColor:taskBorderColor,
            textColor:  taskTextColor,
            opacity:    taskBgOpacity,
            fontSize:   taskFontSize,
            neon:       taskNeon
          },
          feedback: {
            borderColor: feedbackBorderColor,
            textColor:   feedbackTextColor,
            neon:        feedbackNeon
          }
        },
        finalFeedback,
        feedbackImage,
        autoDistractors,
        tasks
      };
    }

    function validate(cfg){
      if(!cfg.tasks || !cfg.tasks.length) return '–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å.';
      return null;
    }

    async function publish(){
      const cfg = collectConfig();
      const err = validate(cfg);
      if(err){ alert(err); return; }

      const id = makeIdFromFirstTask(cfg);
      const payload = {
        id,
        mode: "json",
        folder: "data",
        content: JSON.stringify(cfg, null, 2)
      };
      try{
        const res = await fetch(ENDPOINT, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Publish-Key": PUBLISH_KEY
          },
          body: JSON.stringify(payload)
        });
        if(!res.ok){
          const t = await res.text().catch(()=>res.statusText);
          throw new Error(t || 'Server error');
        }
        const iframe = `<iframe src="${BASE_MAIN}?id=${encodeURIComponent(id)}" width="900" height="640" style="border:0;" allow="autoplay" allowfullscreen></iframe>`;
        $('#iframeOut').value = iframe;
        alert('–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ! –ü–æ–¥–æ–∂–¥–∏—Ç–µ 30‚Äì60 —Å–µ–∫—É–Ω–¥ (–∫–µ—à GitHub Pages).');
      }catch(e){
        alert("–°–µ—Ç—å/—Å–µ—Ä–≤–µ—Ä: " + e.message);
      }
    }

    function makeIdFromFirstTask(cfg){
      const firstQ = (cfg.tasks[0]?.question || 'task').trim();
      const slug = firstQ.toLowerCase()
        .normalize('NFKD').replace(/[\u0300-\u036f]/g,'')
        .replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'')
        .slice(0,40) || 'task';
      const d=new Date(),p=n=>String(n).padStart(2,'0');
      const stamp = `${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}-${p(d.getHours())}${p(d.getMinutes())}${p(d.getSeconds())}`;
      return `${slug}-${stamp}`;
    }

    async function quickTest(){
      const cfg = collectConfig();
      const err = validate(cfg);
      if(err){ alert(err); return; }
      alert('JSON –≤–∞–ª–∏–¥–µ–Ω. –í–æ–ø—Ä–æ—Å–æ–≤: ' + cfg.tasks.length);
      console.log(cfg);
    }

    function copyIframe(){
      const v = $('#iframeOut').value.trim();
      if(!v){ alert('–°–Ω–∞—á–∞–ª–∞ –æ–ø—É–±–ª–∏–∫—É–π—Ç–µ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å iframe.'); return; }
      navigator.clipboard.writeText(v).then(()=>{}).catch(()=>{});
    }

    // Preview
    function refreshPreview(){
      const url = $('#bgImage').value.trim();
      $('#iconPrev').style.backgroundImage = url ? `url(${url})` : 'none';
      const lines = $('#questions').value.split('\n').map(s=>s.trim()).filter(Boolean).length;
      $('#textPrev').textContent = '0 / ' + (lines || 0);
    }

    // Init
    fillLanguageSelect();
    fillFontsForLanguage($('#language').value);

    $('#language').addEventListener('change', e => {
      fillFontsForLanguage(e.target.value);
    });
    $('#font').addEventListener('change', e => {
      applyGoogleFont(e.target.value);
    });

    ['bgImage','questions','finalFeedback'].forEach(id =>
      $('#'+id).addEventListener('input', refreshPreview)
    );

    $('#saveBtn').addEventListener('click', publish);
    $('#testBtn').addEventListener('click', quickTest);
    $('#copyBtn').addEventListener('click', copyIframe);

    refreshPreview();
  </script>
</body>
</html>
